<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeyFiRoom - LSPU Status Viewer</title>

    <!-- STYLING: Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FRONT-END: React, Babel, and Firebase SDKs -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- üõë CRITICAL FIX: Reverting to Stable Firebase v8 CDNs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <!-- QR SCANNER (To be used in Week 2) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. CONFIGURATION & GLOBAL SETUP ---
        const firebaseConfig = {
        apiKey: "AIzaSyDFShCL1h1IZ2me-ek79XHqIpaFR2itBrg",
        authDomain: "keyfiroom-lspu.firebaseapp.com",
        databaseURL: "https://keyfiroom-lspu-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "keyfiroom-lspu",
        storageBucket: "keyfiroom-lspu.firebasestorage.app",
        messagingSenderId: "924604537949",
        appId: "1:924604537949:web:210fe3056f9eb0882381b4",
        //measurementId: "G-XEN24RE55T"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth(); 
        
        const { useState, useEffect, useRef } = React;

        // --- 2. JAVASCRIPT/REACT CODE WILL START HERE ---


        // Function A: formatTime (Solves Readability)

            const formatTime = (isoString) => {
            // 1. If the input is empty (e.g., key is AVAILABLE), return N/A text.
            if (!isoString) return 'N/A'; 
            
            // 2. Creates a JavaScript Date object from the messy string.
            const date = new Date(isoString); 
            
            // 3. Converts the Date object into a readable time string.
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: true // Forces it to display AM/PM format
            });
        };

        // Function B: isKeyOverdue (Solves Accountability)

            const isKeyOverdue = (expectedReturnTime) => {
            // 1. If the key is not checked out, it cannot be overdue.
            if (!expectedReturnTime) return false;
    
            // 2. Compares the key's DUE TIME (left) against the CURRENT TIME (right).
            // If Due Time is EARLIER (less than) the current time, the key is overdue.
            return new Date(expectedReturnTime) < new Date();
        };

        // Function C: calculateReturnTime (Solves Duration Hassle)

            const calculateReturnTime = (durationHours) => {
            // 1. Gets the current time right now.
            const now = new Date();
        
            // 2. Adds the requested duration (1, 2, or 4 hours) to the current time.
            now.setHours(now.getHours() + durationHours); 
        
            // 3. Returns the time in the standardized format required by Firebase.
            return now.toISOString();
        };

        // Function D: signInAdmin (Solves Write Permission)

            // --- WRITE HELPERS (For Week 2) ---
            const signInAdmin = () => {
                
            // Required by Firebase security rules to perform the write action
            return auth.signInAnonymously(); 
        };

        // Function E: writeKeyStatus (Solves Data Persistence)

             const writeKeyStatus = (keyId, updates) => {
             // This function sends the data to the correct path in the database
             const keyRef = database.ref(`Keys/${keyId}`); 

            return keyRef.update(updates); 
        };



        // Function I: calculateTimeLeft (Solves User Confusion / Creates Urgency)

        const calculateTimeLeft = (expectedReturnTime) => {
            if (!expectedReturnTime) return null; // Key is available

            const now = new Date();
            const dueTime = new Date(expectedReturnTime);
            const diffMs = dueTime - now; // Difference in milliseconds

            if (diffMs <= 0) {
                // If the difference is zero or negative, return null so the row handles the OVERDUE state
                return null;
            }

            // Calculate hours and minutes
            const diffMins = Math.floor(diffMs / 60000); // Total minutes left
            const hours = Math.floor(diffMins / 60);
            const minutes = diffMins % 60;

            let output = '';
            if (hours > 0) {
                output += `${hours} hr${hours > 1 ? 's' : ''}`;
            }
            if (minutes > 0 || hours === 0) {
                if (output.length > 0) output += ' ';
                output += `${minutes} min${minutes > 1 ? 's' : ''}`;
            }
            
            return output.trim();
        };


        // Function I-1: writeNewKey (Handles creation of a brand new key entry)

        const writeNewKey = (keyId, name, location) => {
            // Data to be written for the new key's status
            const statusUpdates = {
                status: 'AVAILABLE',
                holderId: null,
                checkoutTime: null,
                expectedReturnTime: null,
                // Include static data directly in the key's object
                name: name,
                location: location
            };

            // This overwrites/creates the key at the specified path
            const keyRef = database.ref(`Keys/${keyId}`); 

            return keyRef.set(statusUpdates); 
        };

        // New Function: deleteKey
        const deleteKey = (keyId) => {
            const keyRef = database.ref(`Keys/${keyId}`);
            return keyRef.remove();
        };

        // Function F: KeyStatusRow (The Visual Element - DEFENSIVE FIX)
        const KeyStatusRow = ({ keyData }) => {
            
            // CRITICAL FIX: If the data is corrupt (missing name or location), do not attempt to render the row.
            // This prevents the rendering error and cleans up the UI instantly.
            if (!keyData || !keyData.name || !keyData.location) {
                // You can return null to skip rendering the corrupt row entirely,
                // or render a placeholder for debugging. Returning null is cleaner for a finished product.
                return null; 
            }

            const isOut = keyData.status === 'OUT';
            const isOverdue = isKeyOverdue(keyData.expectedReturnTime); 
            const timeLeft = calculateTimeLeft(keyData.expectedReturnTime);

            const statusColor = isOverdue 
                        ? 'bg-yellow-500 text-red-900 border-2 border-red-700 animate-pulse shadow-xl' 
                        : isOut 
                        ? 'bg-red-700 text-white shadow-md'
                        : 'bg-emerald-600 text-white shadow-md';

            const statusText = isOverdue ? '‚ö†Ô∏è OVERDUE' : keyData.status;

            return (
                <div className="flex flex-col p-5 mb-3 border-none rounded-2xl shadow-xl bg-white transition hover:shadow-2xl">
                    
                    <div className="flex items-center justify-between">
                        {/* The name is now guaranteed to exist by the check above */}
                        <span className="text-2xl font-extrabold text-teal-800">{keyData.name}</span>
                        <span className={`px-4 py-1 text-sm font-bold rounded-full ${statusColor}`}>
                            {statusText}
                        </span>
                    </div>
                
                    <div className="mt-2 text-md text-gray-600">
                        <p>Location: {keyData.location}</p>
                        {isOut && (
                            <>
                                <p className={`font-extrabold mt-1 ${isOverdue ? 'text-red-700' : 'text-red-600'}`}>
                                    {isOverdue 
                                        ? 'OVERDUE SINCE: ' + formatTime(keyData.expectedReturnTime)
                                        : timeLeft
                                            ? 'AVAILABLE IN: ' + timeLeft
                                            : 'DUE BACK: ' + formatTime(keyData.expectedReturnTime)
                                    }
                                </p>
                                <p className="text-sm">Checked Out By: ID {keyData.holderId || 'Unknown'}</p>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // Function G-1 : KeyManagementPanel (The Key Keeper Forms and Logic - ABSOLUTE FINAL STRUCTURE)

        // --- KEY MANAGEMENT PANEL (Handles Checkout/Return Forms and Logic) ---
        const KeyManagementPanel = ({ keys, selectedKeyId, setSelectedKeyId }) => {
            const keyData = keys[selectedKeyId];
            const [borrowerId, setBorrowerId] = useState('');
            const [duration, setDuration] = useState(2);
            const [isUpdating, setIsUpdating] = useState(false);
            const [editMode, setEditMode] = useState(false);
            const [editName, setEditName] = useState('');
            const [editLocation, setEditLocation] = useState('');

            const isOut = keyData && keyData.status === 'OUT';
            const expectedTime = keyData && keyData.expectedReturnTime ? formatTime(keyData.expectedReturnTime) : 'N/A';
            
            useEffect(() => {
                if (keyData) {
                    setEditName(keyData.name || '');
                    setEditLocation(keyData.location || '');
                }
                setEditMode(false);
            }, [selectedKeyId, keyData]);

            // --- ALL EVENT HANDLERS DEFINED FIRST ---

            // CRITICAL FIX: Robust Status Check is implemented inside handleCheckout

            // --- QR SCAN HANDLING LOGIC ---
            const handleScan = (scannedText) => { 
                const isBorrowerId = scannedText.length > 5 && !isNaN(scannedText); 
                if (isBorrowerId) {
                    setBorrowerId(scannedText); 
                    alert(`Borrower ID Scanned: ${scannedText}. Please select a duration and CHECKOUT.`);
                } else if (keys[scannedText]) {
                    setSelectedKeyId(scannedText); 
                    alert(`Key ID Scanned: ${keys[scannedText].name} selected.`);
                } else {
                    alert(`Scan failed: Scanned text "${scannedText}" does not match a Key or Borrower ID format.`);
                }
            };
            
            // --- CHECKOUT LOGIC (Digital Logbook Entry) ---
            const handleCheckout = async (e) => {
                e.preventDefault();
                
                // CRITICAL FIX: Ensure a valid key is selected and all required inputs are present
                if (!keyData || !selectedKeyId) {
                    alert("Error: Please select a valid key to manage.");
                    return;
                }
                if (!borrowerId || duration < 1) {
                    alert("Borrower ID and Duration are required.");
                    return;
                }

                // CRITICAL FIX: Robust Status Check
                const currentStatus = keyData ? keyData.status : 'AVAILABLE';
                
                if (currentStatus !== 'AVAILABLE') {
                    alert("Error: Key is already checked out or status is corrupted. Current status: " + currentStatus);
                    return;
                }
                
                setIsUpdating(true);
                try {
                    await signInAdmin(); 
                    const expectedReturnTime = calculateReturnTime(duration);
                    
                    const updates = {
                        status: 'OUT',
                        holderId: borrowerId,
                        checkoutTime: new Date().toISOString(),
                        expectedReturnTime: expectedReturnTime,
                    };
                    await writeKeyStatus(selectedKeyId, updates);

                    await database.ref('Logs').push({
                        action: 'CHECKOUT',
                        keyId: selectedKeyId,
                        borrowerId: borrowerId || 'ERROR_UNDEFINED',
                        duration: duration,
                        timestamp: new Date().toISOString(),
                        expectedReturnTime: expectedReturnTime,
                    });
                    
                    alert(`Key ${keyData.name} checked out to ID ${borrowerId} until ${formatTime(expectedReturnTime)}.`);
                    setBorrowerId('');

                } catch (error) {
                    console.error("Checkout failed:", error);
                    alert('Checkout Failed: ' + error.message);
                } finally {
                    setIsUpdating(false);
                }
            };
            
            // --- RETURN LOGIC (Resets status to AVAILABLE) ---
            const handleReturn = async () => {
                if (!confirm(`Are you sure you want to mark ${keyData.name} as returned?`)) return;

                setIsUpdating(true);
                try {
                    await signInAdmin(); 

                    const updates = {
                        status: 'AVAILABLE',
                        holderId: null,
                        checkoutTime: null,
                        expectedReturnTime: null,
                    };
                    await writeKeyStatus(selectedKeyId, updates);
                    
                    await database.ref('Logs').push({
                        action: 'RETURN',
                        keyId: selectedKeyId,
                        borrowerId: keyData.holderId,
                        timestamp: new Date().toISOString(), 
                    });

                    alert(`Key ${keyData.name} marked as AVAILABLE.`);
                    setBorrowerId('');

                } catch (error) {
                    console.error("Return failed:", error);
                    alert('Return Failed: ' + error.message);
                } finally {
                    setIsUpdating(false);
                }
            };

            // --- EDIT LOGIC ---
            const handleEdit = async (e) => {
                e.preventDefault();
                if (!editName || !editLocation) {
                    alert("Name and Location are required.");
                    return;
                }

                setIsUpdating(true);
                try {
                    await signInAdmin();
                    const updates = {
                        name: editName,
                        location: editLocation,
                    };
                    await writeKeyStatus(selectedKeyId, updates);
                    alert(`Key ${editName} updated successfully.`);
                    setEditMode(false);
                } catch (error) {
                    console.error("Edit failed:", error);
                    alert('Edit Failed: ' + error.message);
                } finally {
                    setIsUpdating(false);
                }
            };

            // --- DELETE LOGIC ---
            const handleDelete = async () => {
                if (!confirm(`Are you sure you want to delete ${keyData.name}? This action cannot be undone.`)) return;

                setIsUpdating(true);
                try {
                    await signInAdmin();
                    await deleteKey(selectedKeyId);
                    alert(`Key ${keyData.name} deleted successfully.`);
                    setSelectedKeyId(Object.keys(keys)[0] || '');
                } catch (error) {
                    console.error("Delete failed:", error);
                    alert('Delete Failed: ' + error.message);
                } finally {
                    setIsUpdating(false);
                }
            };

            // --- useEffect and REST OF LOGIC ---
            // CRITICAL FIX 3: Reset selected key if it disappears 
            useEffect(() => {
                if (selectedKeyId && !keys[selectedKeyId]) {
                    setSelectedKeyId(Object.keys(keys)[0] || '');
                }
            }, [keys, selectedKeyId]);


            // --- RENDER (JSX) BLOCK HERE ---
            return (
                <div className="p-6 bg-white shadow-2xl rounded-2xl space-y-6"> 
                    <h3 className="text-3xl font-bold text-teal-800 border-b pb-3 mb-4">Key Management</h3>
                    
                    <div className="p-4 border border-teal-200 bg-teal-50 rounded-xl shadow-inner">
                        <QrScanner onScanSuccess={handleScan} />
                    </div>
                    
                    <label className="block space-y-2">
                        <span className="text-lg text-gray-700 font-bold">Select Key to Manage:</span>
                        <select 
                            value={selectedKeyId} 
                            onChange={(e) => setSelectedKeyId(e.target.value)}
                            className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg bg-white focus:ring-teal-500 focus:border-teal-500"
                        >
                            <option value="">-- Select a Key --</option>
                            {Object.keys(keys).map(id => (
                                <option key={id} value={id}>
                                    {keys[id].name} - ({keys[id].status})
                                </option>
                            ))}
                        </select>
                    </label>

                    {selectedKeyId && keyData ? (
                        <>
                            {isOut ? (
                                <div className="p-5 bg-red-100 rounded-xl border-4 border-red-500 shadow-lg"> 
                                    <p className="text-xl font-bold text-red-800 mb-2">Key is currently OUT to ID {keyData.holderId}</p>
                                    <p className="text-md text-gray-700">Due: {expectedTime}</p>
                                    <button 
                                        onClick={handleReturn}
                                        className="w-full bg-emerald-700 text-white p-4 rounded-xl font-bold mt-4 text-lg hover:bg-emerald-800 transition shadow-md"
                                        disabled={isUpdating}
                                    >
                                        {isUpdating ? 'Processing Return...' : 'Mark Key as RETURNED'}
                                    </button>
                                </div>
                            ) : (
                                <form onSubmit={handleCheckout} className="p-5 bg-emerald-100 rounded-xl border-4 border-emerald-500 shadow-lg space-y-5">
                                    <h4 className="text-2xl font-extrabold text-emerald-800">Checkout Available Key</h4>
                                    
                                    <label className="block space-y-2">
                                        <span className="text-lg text-gray-700 font-bold">Borrower ID (Scan or Type):</span>
                                        <input 
                                            type="text" 
                                            value={borrowerId} 
                                            onChange={(e) => setBorrowerId(e.target.value.toUpperCase().replace(/\s/g, ''))}
                                            placeholder="Enter Student/Faculty ID"
                                            className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg focus:ring-teal-500 focus:border-teal-500" 
                                            required
                                            minLength={4}
                                        />
                                    </label>

                                    <label className="block space-y-2">
                                        <span className="text-lg text-gray-700 font-bold">Duration (Hours):</span>
                                        <select 
                                            value={duration} 
                                            onChange={(e) => setDuration(parseInt(e.target.value))}
                                            className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg bg-white"
                                        >
                                            <option value={1}>1 Hour</option>
                                            <option value={2}>2 Hours</option>
                                            <option value={4}>4 Hours</option>
                                            <option value={8}>8 Hours (Full Day)</option>
                                        </select>
                                    </label>
                                    
                                    <button 
                                        type="submit" 
                                        className="w-full bg-teal-700 text-white p-4 rounded-xl font-bold text-lg hover:bg-teal-800 transition shadow-md"
                                        disabled={isUpdating}
                                    >
                                        {isUpdating ? 'Processing...' : 'CHECKOUT Key'}
                                    </button>
                                </form>
                            )}

                            {/* Edit/Delete Section */}
                            <div className="mt-6 flex space-x-4">
                                <button 
                                    onClick={() => setEditMode(!editMode)}
                                    className="flex-1 bg-yellow-600 text-white p-3 rounded-xl font-bold hover:bg-yellow-700 transition shadow-md"
                                    disabled={isUpdating || !keyData}
                                >
                                    {editMode ? 'Cancel Edit' : 'Edit Key'}
                                </button>
                                <button 
                                    onClick={handleDelete}
                                    className="flex-1 bg-red-600 text-white p-3 rounded-xl font-bold hover:bg-red-700 transition shadow-md"
                                    disabled={isUpdating || !keyData}
                                >
                                    Delete Key
                                </button>
                            </div>

                            {editMode && (
                                <form onSubmit={handleEdit} className="p-5 bg-yellow-100 rounded-xl border-4 border-yellow-500 shadow-lg space-y-5">
                                    <h4 className="text-2xl font-extrabold text-yellow-800">Edit Key Details</h4>
                                    
                                    <label className="block space-y-2">
                                        <span className="text-lg text-gray-700 font-bold">Key Name:</span>
                                        <input 
                                            type="text" 
                                            value={editName} 
                                            onChange={(e) => setEditName(e.target.value)}
                                            className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg focus:ring-teal-500 focus:border-teal-500" 
                                            required
                                        />
                                    </label>

                                    <label className="block space-y-2">
                                        <span className="text-lg text-gray-700 font-bold">Location:</span>
                                        <input 
                                            type="text" 
                                            value={editLocation} 
                                            onChange={(e) => setEditLocation(e.target.value)}
                                            className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg focus:ring-teal-500 focus:border-teal-500" 
                                            required
                                        />
                                    </label>
                                    
                                    <button 
                                        type="submit" 
                                        className="w-full bg-yellow-700 text-white p-4 rounded-xl font-bold text-lg hover:bg-yellow-800 transition shadow-md"
                                        disabled={isUpdating}
                                    >
                                        {isUpdating ? 'Saving...' : 'Save Changes'}
                                    </button>
                                </form>
                            )}
                        </>
                    ) : (
                        <p className="text-center text-gray-500">Select a key to manage.</p>
                    )}
                </div>
            );
        };

        // Function I: QrScanner (Handles Camera Input - FIX: Cleanup Logic)

        // --- QR SCANNER COMPONENT (Wrapper for the html5-qrcode library) ---
        const QrScanner = ({ onScanSuccess }) => {
            const qrCodeRegionId = 'reader-area';
            const [isScanning, setIsScanning] = useState(false);
            const html5QrCode = useRef(null);
            
            useEffect(() => {
                html5QrCode.current = new Html5Qrcode(qrCodeRegionId);
                
                return () => {
                    if (html5QrCode.current && html5QrCode.current.isScanning) {
                        html5QrCode.current.stop().catch(err => {
                            console.error("Error stopping scanner on unmount:", err);
                        });
                    }
                };
            }, []); // Empty dependency array ensures this runs once

            const startScanning = () => {
                const config = { 
                    fps: 10, 
                    qrbox: { width: 250, height: 250 } 
                };

                const onScan = (decodedText, decodedResult) => {
                    stopScanning();
                    console.log("QR Code scanned successfully:", decodedText);
                    onScanSuccess(decodedText); 
                };

                html5QrCode.current.start(
                    { facingMode: "environment" }, 
                    config, 
                    onScan, 
                    (errorMessage) => { 
                        // console.warn(`QR Code scanning error: ${errorMessage}`); 
                    }
                ).then(() => {
                    setIsScanning(true);
                }).catch(err => {
                    console.error("Error starting camera:", err);
                });
            };

            const stopScanning = () => {
                if (html5QrCode.current && html5QrCode.current.isScanning) {
                    html5QrCode.current.stop().then(() => {
                        setIsScanning(false);
                    }).catch(err => {
                        console.error("Error stopping the scanner:", err);
                    });
                }
            };

            // The component only needs a single div element to host the camera feed
            return (
                <div className="p-4 bg-gray-100 rounded-lg">
                    <h4 className="text-lg font-bold text-gray-800 mb-2">Scan QR Code</h4>
                    <div id={qrCodeRegionId} className="w-full h-64 border-2 border-dashed border-gray-300 rounded-lg overflow-hidden">
                        {/* Camera view will render here */}
                    </div>
                    <button 
                        onClick={isScanning ? stopScanning : startScanning}
                        className="w-full mt-2 bg-blue-500 text-white p-2 rounded font-bold hover:bg-blue-600"
                    >
                        {isScanning ? 'Stop Scanning' : 'Start Scanning'}
                    </button>
                    <p className="text-sm text-gray-500 mt-2 text-center">
                        Point the camera at the Key or Borrower ID QR code.
                    </p>
                </div>
            );
        };

        // Function I-2: KeyCreator (Handles Admin form for adding new keys)

        const KeyCreator = () => {
            const [newKeyId, setNewKeyId] = useState('');
            const [newKeyName, setNewKeyName] = useState('');
            const [newKeyLocation, setNewKeyLocation] = useState('');
            const [isCreating, setIsCreating] = useState(false);

            const handleCreate = async (e) => {
                e.preventDefault();
                if (!newKeyId || !newKeyName || !newKeyLocation) {
                    alert("All fields are required to create a new key.");
                    return;
                }

                setIsCreating(true);
                try {
                    // Ensure admin is signed in before write (safety check)
                    await signInAdmin(); 
                    
                    // Write the new key data using the helper function
                    await writeNewKey(
                        newKeyId.toUpperCase().replace(/\s/g, '_'), // Standardize the ID format
                        newKeyName, 
                        newKeyLocation
                    );

                    alert(`New Key '${newKeyName}' created successfully!`);
                    
                    // Clear the form
                    setNewKeyId('');
                    setNewKeyName('');
                    setNewKeyLocation('');

                } catch (error) {
                    console.error("Key creation failed:", error);
                    alert('Key Creation Failed: ' + error.message);
                } finally {
                    setIsCreating(false);
                }
            };

            return (
                <div className="p-5 bg-teal-100 rounded-xl border-4 border-teal-500 shadow-lg space-y-4">
                    <h4 className="text-2xl font-extrabold text-teal-800 border-b pb-2">Add New Key to System</h4>
                    <form onSubmit={handleCreate} className="space-y-4">
                        <input
                            type="text"
                            value={newKeyId}
                            onChange={(e) => setNewKeyId(e.target.value)}
                            placeholder="Enter Unique Key ID (e.g., LAB_3_KEY)"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg text-md focus:ring-teal-500 focus:border-teal-500"
                            required
                        />
                        <input
                            type="text"
                            value={newKeyName}
                            onChange={(e) => setNewKeyName(e.target.value)}
                            placeholder="Key Name (e.g., Classroom 302 Key)"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg text-md focus:ring-teal-500 focus:border-teal-500"
                            required
                        />
                        <input
                            type="text"
                            value={newKeyLocation}
                            onChange={(e) => setNewKeyLocation(e.target.value)}
                            placeholder="Location (e.g., CCS Building)"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg text-md focus:ring-teal-500 focus:border-teal-500"
                            required
                        />
                        <button
                            type="submit"
                            className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold text-lg hover:bg-blue-700 transition shadow-md"
                            disabled={isCreating}
                        >
                            {isCreating ? 'Creating...' : 'Add Key'}
                        </button>
                    </form>
                </div>
            );
        };

        // Function I-3: TransactionHistory (Reads and displays the transaction log)

        const TransactionHistory = () => {
            const [logs, setLogs] = useState([]);
            const [loadingLogs, setLoadingLogs] = useState(true);

            useEffect(() => {
                const logsRef = database.ref('Logs');
                
                // Order logs by the timestamp and limit to the last 20 entries
                // 'child_added' is efficient for building an ordered list
                logsRef.orderByChild('timestamp').limitToLast(20).on('value', (snapshot) => {
                    const logsArray = [];
                    snapshot.forEach(childSnapshot => {
                        // Push the log data along with its Firebase unique ID
                        logsArray.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });

                    // Reverse the array so the newest log is at the top
                    setLogs(logsArray.reverse());
                    setLoadingLogs(false);
                });

                // Cleanup listener
                return () => logsRef.off();
            }, []);

            if (loadingLogs) {
                return <p className="text-center text-gray-500">Loading Transaction History...</p>;
            }

            if (logs.length === 0) {
                return <p className="text-center text-gray-500">No transactions recorded yet.</p>;
            }

            return (
                <div className="p-5 bg-white shadow-2xl rounded-2xl space-y-4">
                    <h3 className="text-2xl font-bold text-teal-800 border-b pb-2">Recent Transaction Log (Last 20)</h3>
                    
                    <div className="space-y-3 max-h-96 overflow-y-auto">
                        {logs.map((log) => (
                            <div key={log.id} className={`p-3 rounded-lg border-l-4 ${log.action === 'CHECKOUT' ? 'bg-red-50 border-red-500' : 'bg-green-50 border-green-500'}`}>
                                <p className="text-sm font-bold text-gray-800 flex justify-between">
                                    <span>
                                        <span className={`px-2 py-0.5 rounded-full text-xs font-extrabold ${log.action === 'CHECKOUT' ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`}>
                                            {log.action}
                                        </span>
                                        <span className="ml-2 font-extrabold text-teal-800">{log.keyId}</span>
                                    </span>
                                    {/* The robust timestamp display is here */}
                                    <span className="text-xs text-gray-500">
                                        {log.timestamp 
                                            ? `${new Date(log.timestamp).toLocaleDateString()} ${formatTime(log.timestamp)}`
                                            : 'N/A'
                                        }
                                    </span>
                                </p>
                                <p className="text-xs mt-1 text-gray-600">
                                    Borrower ID: {log.borrowerId || 'N/A'} 
                                    {log.duration && ` | Duration: ${log.duration} hrs`}
                                </p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };


        // Function J: UserAuth (Handles Registration and Login)

            const UserAuth = ({ onLoginSuccess }) => {
                const [isRegistering, setIsRegistering] = useState(false);
                const [email, setEmail] = useState('');
                const [password, setPassword] = useState('');
                const [borrowerId, setBorrowerId] = useState(''); // NEW: The Student/Faculty ID
                const [isProcessing, setIsProcessing] = useState(false);
                const [error, setError] = useState('');

                const handleAuth = async (e) => {
                    e.preventDefault();
                    setError('');
                    setIsProcessing(true);

                    try {
                        if (isRegistering) {
                            // 1. Create User in Firebase Authentication
                            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                            
                            // 2. Store user data (Borrower ID) in Firebase Realtime Database
                            await database.ref(`Borrowers/${userCredential.user.uid}`).set({
                                email: email,
                                borrowerId: borrowerId.toUpperCase(), // Standardize ID format
                                createdAt: new Date().toISOString(),
                            });
                            
                            alert('Registration successful! Please log in.');
                            setIsRegistering(false); // Switch to login after registration

                        } else {
                            // 1. Sign In User
                            const userCredential = await auth.signInWithEmailAndPassword(email, password);
                            
                            // 2. Fetch the corresponding Borrower ID from the database
                            const snapshot = await database.ref(`Borrowers/${userCredential.user.uid}/borrowerId`).once('value');
                            const loggedInBorrowerId = snapshot.val();
                            
                            if (loggedInBorrowerId) {
                                onLoginSuccess(userCredential.user, loggedInBorrowerId); // Pass user and ID back to App
                            } else {
                                // This happens if the user exists in Auth but not in Realtime DB (corrupted)
                                throw new Error("Borrower ID not found. Please contact admin.");
                            }
                        }
                    } catch (err) {
                        console.error("Authentication failed:", err);
                        setError(err.message);
                    } finally {
                        setIsProcessing(false);
                    }
                };

                return (
                    <div className="max-w-md mx-auto p-6 mt-10 bg-white shadow-2xl rounded-xl space-y-4"> 
                        <h2 className="text-3xl font-bold text-teal-800 text-center">
                            {isRegistering ? 'New Borrower Registration' : 'Borrower Login'}
                        </h2>
                        
                        <form onSubmit={handleAuth} className="space-y-4">
                            {isRegistering && (
                                <input
                                    type="text"
                                    value={borrowerId}
                                    onChange={(e) => setBorrowerId(e.target.value.toUpperCase().replace(/\s/g, ''))}
                                    placeholder="Student/Faculty ID (e.g., S2022-001)"
                                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required={isRegistering}
                                    minLength={4}
                                />
                            )}
                            <input
                                type="email"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                placeholder="Email Address"
                                className="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required
                            />
                            <input
                                type="password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                placeholder="Password (min 6 characters)"
                                className="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required
                                minLength={6}
                            />
                            
                            {error && <p className="text-red-600 text-sm">{error}</p>}

                            <button
                                type="submit"
                                className="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-md"
                                disabled={isProcessing}
                            >
                                {isProcessing ? 'Processing...' : isRegistering ? 'Register & Create Account' : 'Log In'}
                            </button>
                        </form>
                        
                        <button
                            onClick={() => setIsRegistering(!isRegistering)}
                            className="w-full text-sm text-gray-500 hover:text-teal-700"
                            disabled={isProcessing}
                        >
                            {isRegistering ? 'Already have an account? Login here.' : 'Need to register? Create an account.'}
                        </button>
                    </div>
                );
            };


            // Function K: QrGenerator (Renders a QR code image)

            const QrGenerator = ({ data, size = 200, name = 'Code' }) => {
                // 1. Encode the data for the URL
                const encodedData = encodeURIComponent(data);
                
                // 2. Google Charts API URL structure
                // üõë ALTERNATE FIX: Protocol-relative URL
                const qrCodeUrl = `//chart.googleapis.com/chart?chs=${size}x${size}&cht=qr&chl=${encodedData}`;

                // 3. Render the image and a download button
                return (
                    <div className="flex flex-col items-center p-4 bg-white rounded-xl shadow-inner border border-gray-200">
                        <h4 className="text-lg font-bold text-gray-700 mb-2">QR Code for: {name}</h4>
                        <img src={qrCodeUrl} alt={`${name} QR Code`} className="w-48 h-48 border border-gray-300 p-1 mb-3" />
                        <a 
                            href={qrCodeUrl} 
                            download={`${name}_QR_Code.png`}
                            className="w-full text-center bg-teal-600 text-white p-2 rounded-lg font-semibold hover:bg-teal-700 transition"
                        >
                            Download QR Code
                        </a>
                        <p className="text-xs mt-2 text-gray-500">
                            Data: <span className="font-mono text-teal-800 break-all">{data}</span>
                        </p>
                    </div>
                );
            };


        // Function G-2 : AdminPortal (Updated for Thematic Separation)

        // --- ADMIN PORTAL COMPONENT (Handles Login Gate) ---
        const AdminPortal = ({ keys }) => {
            // State to manage input and authentication status
            const [passcode, setPasscode] = useState('');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isSigningIn, setIsSigningIn] = useState(false);
            const [selectedKeyId, setSelectedKeyId] = useState(() => Object.keys(keys).find(id => keys[id] && keys[id].name) || Object.keys(keys)[0] || '');

            // Logic to attempt sign-in and password check
            const handleLogin = async (e) => {
                e.preventDefault();
                // Prototype Password Check: Simple security gate
                if (passcode !== 'CCS2025') { 
                    alert('Invalid Passcode. Use CCS2025');
                    return;
                }
                setIsSigningIn(true);
                try {
                    // Signs the user into Firebase anonymously to grant write permission
                    await signInAdmin(); 
                    setIsAuthenticated(true); 
                } catch (error) {
                    alert('Authentication Failed: ' + error.message);
                } finally {
                    setIsSigningIn(false);
                }
            };

            if (!isAuthenticated) {
                // --- LOGIN SCREEN RENDER: Dark Theme for Security Gate ---
                return (
                    // NEW: Darker background for the login box
                    <div className="max-w-xs mx-auto p-6 mt-10 bg-teal-800 shadow-2xl rounded-xl"> 
                        <h2 className="text-xl font-bold text-white mb-4 text-center">Key Keeper Login</h2>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input
                                type="password"
                                value={passcode}
                                onChange={(e) => setPasscode(e.target.value.toUpperCase())}
                                placeholder="Enter Passcode (CCS2025)"
                                // Input colors adjusted for dark background
                                className="w-full p-3 border border-teal-600 rounded-lg focus:ring-blue-500 text-teal-900 placeholder-gray-500"
                                disabled={isSigningIn}
                            />
                            <button
                                type="submit"
                                // Button uses the bright, active TEAL-600 color
                                className="w-full bg-teal-600 text-white p-3 rounded-lg font-semibold hover:bg-teal-700 transition shadow-lg"
                                disabled={isSigningIn}
                            >
                                {isSigningIn ? 'Signing In...' : 'Access Portal'}
                            </button>
                        </form>
                    </div>
                );
            }

            // If authenticated, render the Key Management Panel
            return (
                <div className="space-y-6">

                    {/* NEW: Key Creation Component */}
                    <KeyCreator /> 

                    {/* Checkout/Return Forms */}
                    <KeyManagementPanel keys={keys} selectedKeyId={selectedKeyId} setSelectedKeyId={setSelectedKeyId} />
                    
                    {/* NEW: Transaction History Viewer */}
                    <TransactionHistory />
                    
                </div>
            );
        };



        // Function H: The Main App Component (Final Fixed Structure + AUTH)
        const App = () => {
            const [keys, setKeys] = useState({});
            const [loading, setLoading] = useState(true);
            // üõë NEW: 'public', 'admin', 'user' (logged-in borrower)
            const [viewMode, setViewMode] = useState('public'); 
            const [currentTime, setCurrentTime] = useState(new Date());
            
            // üõë NEW AUTH STATES
            const [loggedInUser, setLoggedInUser] = useState(null); // Firebase User Object
            const [loggedInBorrowerId, setLoggedInBorrowerId] = useState(null); // Student/Faculty ID
            const [selectedKeyForQr, setSelectedKeyForQr] = useState(''); // State for Admin QR Generator
            
            // üõë NEW LOGIN HANDLER
            const handleUserLogin = (user, borrowerId) => {
                setLoggedInUser(user);
                setLoggedInBorrowerId(borrowerId);
                setViewMode('user'); // Switch to the user portal view
                alert(`Welcome, ID ${borrowerId}. You are now logged in.`);
            };
            
            // üõë NEW LOGOUT HANDLER
            const handleUserLogout = () => {
                auth.signOut();
                setLoggedInUser(null);
                setLoggedInBorrowerId(null);
                setViewMode('public');
                alert('You have been logged out.');
            };
            

            // Effect 1: Clock (Drives Countdown and Public Time)
            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            // Effect 2: Firebase Data Fetching
            useEffect(() => {
                const keysRef = database.ref('Keys'); 
                
                keysRef.on('value', (snapshot) => {
                    const liveData = snapshot.val();
                    
                    if (liveData) {
                        setKeys(liveData);
                    } else {
                        setKeys({});
                    }
                    
                    setLoading(false);
                });

                return () => keysRef.off();
            }, []); 
            
            // CRITICAL FIX: Add defensive check to sorting to prevent "a.name is undefined" error
                const keyArray = Object.keys(keys)
                .map(keyId => ({
                    // Inject the unique Firebase key name as the 'id' property
                    id: keyId, 
                    ...keys[keyId] // Spread the rest of the key data (name, location, status, etc.)
                }))
                // Now perform the defensive sort using the guaranteed 'name' property
                .sort((a, b) => {
                    const nameA = a.name || '';
                    const nameB = b.name || '';
                    return nameA.localeCompare(nameB);
                });

            
            // Conditional Loading Check (Uses the themed spinner)
            if (loading) return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-8">
                    <div className="w-12 h-12 border-4 border-teal-500 border-t-transparent border-solid rounded-full animate-spin"></div>
                    <p className="mt-4 text-lg font-semibold text-teal-700">
                        Establishing Realtime Connection...
                    </p>
                    <p className="mt-1 text-sm text-gray-500">
                        Fetching latest key status from the server.
                    </p>
                </div>
            );

            // Final Render
            return (
                    <div className="min-h-screen bg-gray-100 p-2 sm:p-4 font-sans antialiased"> 
                        <div className="max-w-xl lg:max-w-2xl mx-auto space-y-6"> 
                            
                            <header className="py-8 bg-white shadow-lg rounded-b-xl">
                                <h1 className="text-4xl font-extrabold text-teal-800 text-center">
                                    KeyFiRoom - LSPU üîë
                                </h1>
                                <p className="text-center text-md text-gray-500 mt-1">
                                    Check key availability before heading to the office.
                                </p>
                            </header>
                            
                            {/* View Switcher Buttons */}
                            <div className="flex justify-center space-x-2 p-1 bg-white rounded-xl shadow-inner">
                                <button 
                                    onClick={() => setViewMode('public')}
                                    className={`flex-1 p-3 rounded-xl text-sm sm:text-base font-bold transition focus:outline-none ${viewMode === 'public' ? 'bg-blue-700 text-white shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                >
                                    Public Status
                                </button>
                                {/* üõë NEW: Borrower Portal Button */}
                                <button 
                                    onClick={() => setViewMode('user')}
                                    className={`flex-1 p-3 rounded-xl text-sm sm:text-base font-bold transition focus:outline-none ${viewMode === 'user' ? 'bg-green-700 text-white shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                >
                                    Borrower Portal
                                </button>
                                <button 
                                    onClick={() => setViewMode('admin')}
                                    className={`flex-1 p-3 rounded-xl text-sm sm:text-base font-bold transition focus:outline-none ${viewMode === 'admin' ? 'bg-teal-700 text-white shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                >
                                    Admin Action
                                </button>
                            </div>

                            {viewMode === 'public' && (
                                <div className="space-y-4 pt-2">
                                    {/* Dynamic Clock Display */}
                                    <p className="text-sm font-semibold text-gray-700 px-2 text-center">
                                        Current System Time: 
                                        <span className="text-teal-700 ml-2">
                                            {formatTime(currentTime.toISOString())}
                                        </span>
                                    </p>
                                    <h2 className="text-2xl font-extrabold text-gray-800 px-2">Live Status Feed</h2>
                                    
                                    {keyArray.length > 0 ? (
                                        keyArray.map(key => (
                                            <KeyStatusRow key={key.id} keyData={key} />
                                        ))
                                    ) : (
                                        <p className="text-center text-gray-500">No keys available yet.</p>
                                    )}
                                </div>
                            )}
                            
                            {/* üõë NEW: USER AUTH/PORTAL LOGIC */}
                            {viewMode === 'user' && (
                                loggedInUser ? (
                                    <div className="p-6 bg-white shadow-2xl rounded-2xl space-y-6">
                                        <div className="flex justify-between items-center border-b pb-3">
                                            <h2 className="text-3xl font-bold text-green-700">My Borrower Portal</h2>
                                            <button onClick={handleUserLogout} className="bg-red-500 text-white p-2 rounded-lg text-sm font-semibold hover:bg-red-600">
                                                Log Out
                                            </button>
                                        </div>
                                        <p className="text-xl text-gray-700">
                                            Logged in as: <span className="font-extrabold text-green-800">{loggedInBorrowerId}</span>
                                        </p>
                                        
                                        <h3 className="text-2xl font-bold text-gray-800 border-b pb-2">My Identity QR Code</h3>
                                        {/* The QR Code Generator for the user's ID */}
                                        <QrGenerator data={loggedInBorrowerId} name={`ID_${loggedInBorrowerId}`} />

                                        <div className="p-4 bg-green-50 rounded-xl text-sm text-green-800">
                                            <p className="font-semibold">Instruction:</p>
                                            <p>Please use this QR code when checking out keys at the counter. The admin can simply scan this code to input your Borrower ID instantly.</p>
                                        </div>
                                    </div>
                                ) : (
                                    // Show the login/registration form if not logged in
                                    <UserAuth onLoginSuccess={handleUserLogin} />
                                )
                            )}

                            {viewMode === 'admin' && (
                                <>
                                    <AdminPortal keys={keys} />

                                    {/* üõë NEW: ADMIN KEY QR GENERATOR SECTION */}
                                    <div className="p-6 bg-white shadow-2xl rounded-2xl space-y-6">
                                        <h3 className="text-3xl font-bold text-teal-800 border-b pb-3">Key QR Code Generator</h3>
                                        <p className="text-sm text-gray-600">Select a key to generate its unique QR code for printing and binding to the physical key.</p>
                                        
                                        <label className="block space-y-2">
                                            <span className="text-lg text-gray-700 font-bold">Select Key ID:</span>
                                            <select 
                                                value={selectedKeyForQr}
                                                onChange={(e) => setSelectedKeyForQr(e.target.value)}
                                                className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg bg-white"
                                            >
                                                <option value="">-- Select Key to Generate QR --</option>
                                                {keyArray.map(key => (
                                                    <option key={key.id} value={key.id}>
                                                        {key.name} - ({key.id})
                                                    </option>
                                                ))}
                                            </select>
                                        </label>
                                        
                                        {selectedKeyForQr && (
                                            <QrGenerator 
                                                data={selectedKeyForQr} 
                                                name={`${keys[selectedKeyForQr].name}_KEY`} 
                                            />
                                        )}

                                        <div className="p-4 bg-teal-50 rounded-xl text-sm text-teal-800">
                                            <p className="font-semibold">Key Binding Note:</p>
                                            <p>The QR code data is the **Key ID** (e.g., `LAB_3_KEY`). If the physical QR code is lost or damaged, you can simply print a new one using the original Key ID from this list. The key's binding remains secure in the database.</p>
                                        </div>
                                    </div>
                                </>
                            )}

                            <footer className="text-center text-xs text-gray-400 pt-8 pb-4">
                                Developed by CCS Students. Data updates instantly.
                            </footer>
                        </div>
                    </div>
                );
};
        // --- START THE APP ---
        
        // --- 3. THE RENDER CALL WILL BE AT THE VERY BOTTOM (React 18 Update) ---

        // NEW: Uses the modern createRoot API to suppress the React 18 deprecation warning
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
    </script>
</body>
</html>