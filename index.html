<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeyFiRoom - LSPU Status Viewer</title>

    <!-- STYLING: Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FRONT-END: React, Babel, and Firebase SDKs -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- EXTERNAL-API : QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- üõë CRITICAL FIX: Reverting to Stable Firebase v8 CDNs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <!-- QR SCANNER (To be used in Week 2) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. CONFIGURATION & GLOBAL SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyDFShCL1h1IZ2me-ek79XHqIpaFR2itBrg",
            authDomain: "keyfiroom-lspu.firebaseapp.com",
            databaseURL: "https://keyfiroom-lspu-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "keyfiroom-lspu",
            storageBucket: "keyfiroom-lspu.firebasestorage.app",
            messagingSenderId: "924604537949",
            appId: "1:924604537949:web:210fe3056f9eb0882381b4",
            //measurementId: "G-XEN24RE55T"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        const { useState, useEffect, useRef } = React;

        // --- 2. JAVASCRIPT/REACT CODE WILL START HERE ---


        // Function A: formatTime (Solves Readability)

        const formatTime = (isoString) => {
            // 1. If the input is empty (e.g., key is AVAILABLE), return N/A text.
            if (!isoString) return 'N/A';

            // 2. Creates a JavaScript Date object from the messy string.
            const date = new Date(isoString);

            // 3. Converts the Date object into a readable time string.
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true // Forces it to display AM/PM format
            });
        };

        // Function B: isKeyOverdue (Solves Accountability)

        const isKeyOverdue = (expectedReturnTime) => {
            // 1. If the key is not checked out, it cannot be overdue.
            if (!expectedReturnTime) return false;

            // 2. Compares the key's DUE TIME (left) against the CURRENT TIME (right).
            // If Due Time is EARLIER (less than) the current time, the key is overdue.
            return new Date(expectedReturnTime) < new Date();
        };

        // Function C: calculateReturnTime (Solves Duration Hassle)

        const calculateReturnTime = (durationHours) => {
            // 1. Gets the current time right now.
            const now = new Date();

            // 2. Adds the requested duration (1, 2, or 4 hours) to the current time.
            now.setHours(now.getHours() + durationHours);

            // 3. Returns the time in the standardized format required by Firebase.
            return now.toISOString();
        };

        // Function D: signInAdmin (Solves Write Permission)

        // --- WRITE HELPERS (For Week 2) ---
        const signInAdmin = () => {

            // Required by Firebase security rules to perform the write action
            return auth.signInAnonymously();
        };

        // Function E: writeKeyStatus (Solves Data Persistence)

        const writeKeyStatus = (keyId, updates) => {
            // This function sends the data to the correct path in the database
            const keyRef = database.ref(`Keys/${keyId}`);

            return keyRef.update(updates);
        };



        // Function I: calculateTimeLeft (Solves User Confusion / Creates Urgency)

        const calculateTimeLeft = (expectedReturnTime) => {
            if (!expectedReturnTime) return null; // Key is available

            const now = new Date();
            const dueTime = new Date(expectedReturnTime);
            const diffMs = dueTime - now; // Difference in milliseconds

            if (diffMs <= 0) {
                // If the difference is zero or negative, return null so the row handles the OVERDUE state
                return null;
            }

            // Calculate hours and minutes
            const diffMins = Math.floor(diffMs / 60000); // Total minutes left
            const hours = Math.floor(diffMins / 60);
            const minutes = diffMins % 60;

            let output = '';
            if (hours > 0) {
                output += `${hours} hr${hours > 1 ? 's' : ''}`;
            }
            if (minutes > 0 || hours === 0) {
                if (output.length > 0) output += ' ';
                output += `${minutes} min${minutes > 1 ? 's' : ''}`;
            }

            return output.trim();
        };


        // Function I-1: writeNewKey (Handles creation of a brand new key entry)

        const writeNewKey = (keyId, name, location) => {
            // Data to be written for the new key's status
            const statusUpdates = {
                status: 'AVAILABLE',
                holderId: null,
                checkoutTime: null,
                expectedReturnTime: null,
                // Include static data directly in the key's object
                name: name,
                location: location
            };

            // This overwrites/creates the key at the specified path
            const keyRef = database.ref(`Keys/${keyId}`);

            return keyRef.set(statusUpdates);
        };

        // New Function: deleteKey
        const deleteKey = (keyId) => {
            const keyRef = database.ref(`Keys/${keyId}`);
            return keyRef.remove();
        };

        // Function F: KeyStatusRow (The Visual Element - UPDATED FOR RESERVATION)

        const KeyStatusRow = ({ keyData }) => {
            
            // CRITICAL FIX: If the data is corrupt, return null.
            if (!keyData || !keyData.name || !keyData.location) {
                return null; 
            }

            const isOut = keyData.status === 'OUT';
            const isReserved = keyData.status === 'RESERVED';
            const isOverdue = isKeyOverdue(keyData.expectedReturnTime); 
            const timeLeft = calculateTimeLeft(keyData.expectedReturnTime);

            // --- 1. DETERMINE STATUS TEXT AND COLOR ---
            let statusText = keyData.status;
            let statusColor = 'bg-gray-400 text-white shadow-md'; // Default

            if (isOverdue) {
                statusText = '‚ö†Ô∏è OVERDUE';
                statusColor = 'bg-yellow-500 text-red-900 border-2 border-red-700 animate-pulse shadow-xl';
            } else if (isOut) {
                statusColor = 'bg-red-700 text-white shadow-md';
            } else if (isReserved) {
                statusText = `RESERVED (${formatTime(keyData.reservationStart)})`;
                statusColor = 'bg-purple-600 text-white shadow-md';
            } else {
                statusColor = 'bg-emerald-600 text-white shadow-md';
                statusText = 'AVAILABLE';
            }

            return (
                <div className="flex flex-col p-5 mb-3 border-none rounded-2xl shadow-xl bg-white transition hover:shadow-2xl">
                    
                    <div className="flex items-center justify-between">
                        <span className="text-2xl font-extrabold text-teal-800">{keyData.name}</span>
                        <span className={`px-4 py-1 text-sm font-bold rounded-full ${statusColor}`}>
                            {statusText}
                        </span>
                    </div>
                
                    <div className="mt-2 text-md text-gray-600">
                        <p>Location: {keyData.location}</p>

                        {/* 2. RENDER DETAILS based on status */}
                        {isOut && (
                            <>
                                <p className={`font-extrabold mt-1 ${isOverdue ? 'text-red-700' : 'text-red-600'}`}>
                                    {isOverdue 
                                        ? 'OVERDUE SINCE: ' + formatTime(keyData.expectedReturnTime)
                                        : timeLeft
                                            ? 'AVAILABLE IN: ' + timeLeft
                                            : 'DUE BACK: ' + formatTime(keyData.expectedReturnTime)
                                    }
                                </p>
                                <p className="text-sm">Checked Out By: ID {keyData.holderId || 'Unknown'}</p>
                            </>
                        )}

                        {isReserved && (
                            <>
                                <p className="font-extrabold mt-1 text-purple-700">
                                    RESERVED: {formatTime(keyData.reservationStart)} - {formatTime(keyData.reservationEnd)}
                                </p>
                                <p className="text-sm">Reserved By: ID {keyData.reservedBy || 'Unknown'}</p>
                            </>
                        )}
                    </div>
                </div>
            );
        };  

        // Function G-1 : KeyManagementPanel (The Key Keeper Forms and Logic - FINAL RESERVATION IMPLEMENTATION)

        // --- KEY MANAGEMENT PANEL (Handles Checkout/Return/Reserve Forms and Logic) ---
        const KeyManagementPanel = ({ keys, selectedKeyId, setSelectedKeyId }) => {
            const keyData = keys[selectedKeyId];
            const [borrowerId, setBorrowerId] = useState('');
            const [duration, setDuration] = useState(2);
            const [isUpdating, setIsUpdating] = useState(false);
            const [editMode, setEditMode] = useState(false);
            const [editName, setEditName] = useState('');
            const [editLocation, setEditLocation] = useState('');

            const isOut = keyData && keyData.status === 'OUT';
            // NEW: Check if RESERVED status is active
            const isReserved = keyData && keyData.status === 'RESERVED';
            const expectedTime = keyData && keyData.expectedReturnTime ? formatTime(keyData.expectedReturnTime) : 'N/A';

            // ... (useEffect hook for edit mode is UNCHANGED)
            useEffect(() => {
                if (keyData) {
                    setEditName(keyData.name || '');
                    setEditLocation(keyData.location || '');
                }
                setEditMode(false);
            }, [selectedKeyId, keyData]);


            // --- QR SCAN HANDLING LOGIC (UPDATED FOR JSON TRANSACTION AND RESERVATION) ---
            const handleScan = (scannedText) => {

                // --- 1. Attempt to Parse as JSON (Transaction QR: CHECKOUT or RESERVE) ---
                try {
                    const transaction = JSON.parse(scannedText);

                    if (transaction.action === "CHECKOUT" && transaction.keyId && transaction.borrowerId && transaction.duration) {

                        // 1a. Immediate Checkout Transaction QR Scanned
                        setSelectedKeyId(transaction.keyId);
                        setBorrowerId(JSON.stringify(transaction)); // Store full JSON for checkout/reserve distinction
                        setDuration(transaction.duration); // Used for display/manual checkout

                        alert(`IMMEDIATE CHECKOUT REQUEST LOADED: Key ${keys[transaction.keyId]?.name || transaction.keyId} for ID ${transaction.borrowerId}. Please CONFIRM.`);
                        return;
                    }

                    if (transaction.action === "RESERVE" && transaction.keyId && transaction.borrowerId && transaction.reservationStart) {

                        // 1b. Reservation Transaction QR Scanned
                        setSelectedKeyId(transaction.keyId);
                        setBorrowerId(JSON.stringify(transaction)); // Store full JSON payload for reservation processing

                        alert(`RESERVATION REQUEST LOADED: Key ${keys[transaction.keyId]?.name || transaction.keyId} for ID ${transaction.borrowerId} from ${formatTime(transaction.reservationStart)}. Please click the 'PROCESS RESERVATION' button.`);
                        return;
                    }

                    if (transaction.action === "RETURN" && transaction.keyId) {
                        // 1c. Return Transaction QR Scanned
                        setSelectedKeyId(transaction.keyId);
                        alert(`RETURN REQUEST LOADED: Key ${keys[transaction.keyId]?.name || transaction.keyId}. Please CONFIRM RETURN.`);
                        return;
                    }

                } catch (e) {
                    // Continue to fallback checks if parsing fails
                }

                // --- 2. Fallback: Simple Key ID Scan (Permanent Key QR) ---
                if (keys[scannedText]) {
                    setSelectedKeyId(scannedText);
                    setBorrowerId(''); // Clear borrower ID if a key is scanned
                    alert(`Key ID Scanned: ${keys[scannedText].name} selected for action.`);
                    return;
                }

                // --- 3. Fallback: Simple Borrower ID Scan (Manual/Old ID QR) ---
                const isBorrowerId = !isNaN(scannedText) && scannedText.length >= 4;
                if (isBorrowerId) {
                    setBorrowerId(scannedText);
                    alert(`Borrower ID Scanned: ${scannedText}. Please select Key and Duration manually.`);
                    return;
                }

                // --- 4. Final Failover ---
                alert(`Scan failed: Scanned text "${scannedText}" does not match any known transaction, key, or borrower ID.`);
            };

        // Inside Function G-1: KeyManagementPanel

        // --- CHECKOUT LOGIC (MODIFIED for JSON payload) ---
        const handleCheckout = async (e) => {
            e.preventDefault();
            
            // Check if borrowerId is holding JSON data (from a scan)
            let finalBorrowerId = borrowerId;
            let finalDuration = duration;
            
            try {
                const txn = JSON.parse(borrowerId);
                if (txn.action === 'CHECKOUT') {
                    finalBorrowerId = txn.borrowerId;
                    finalDuration = txn.duration;
                }
                // NOTE: If the scanned data was RESERVE, this form shouldn't be visible,
                // but we handle the parsing defensively here just in case.
            } catch (e) {
                // borrowerId is plain text (manual input or simple borrower ID scan), use manual inputs
            }

            if (!keyData || !selectedKeyId) {
                alert("Error: Please select a valid key to manage.");
                return;
            }
            if (!finalBorrowerId || finalDuration < 1) {
                alert("Borrower ID and Duration are required.");
                return;
            }
            
            const currentStatus = keyData ? keyData.status : 'AVAILABLE';
            
            // Also check if the key is currently RESERVED (prevent checkout by another user)
            if (currentStatus !== 'AVAILABLE') {
                alert(`Error: Key is currently ${currentStatus}. Cannot check out.`);
                return;
            }
            
            setIsUpdating(true);
            try {
                await signInAdmin(); 
                const expectedReturnTime = calculateReturnTime(finalDuration);
                
                const updates = {
                    status: 'OUT',
                    holderId: finalBorrowerId,
                    checkoutTime: new Date().toISOString(),
                    expectedReturnTime: expectedReturnTime,
                    // Clear reservation fields if they somehow existed
                    reservedBy: null, 
                    reservationStart: null,
                    reservationEnd: null,
                };
                await writeKeyStatus(selectedKeyId, updates);

                // Prepare and write log data to global Logs
                const logData = {
                    action: 'CHECKOUT',
                    keyId: selectedKeyId,
                    borrowerId: finalBorrowerId || 'ERROR_UNDEFINED',
                    duration: finalDuration,
                    timestamp: new Date().toISOString(),
                    expectedReturnTime: expectedReturnTime,
                };
                await database.ref('Logs').push(logData);
                
                alert(`Key ${keyData.name} checked out to ID ${finalBorrowerId} until ${formatTime(expectedReturnTime)}.`);
                setBorrowerId(''); // Clear state
                setSelectedKeyId(''); // Reset selected key to force form refresh

            } catch (error) {
                console.error("Checkout failed:", error);
                alert('Checkout Failed: ' + error.message);
            } finally {
                setIsUpdating(false);
            }
        };

            // --- RESERVATION LOGIC (NEW) ---
            const handleReserve = async () => {
                // We know the borrowerId state holds the JSON string after a successful scan
                let transaction;
                try {
                    transaction = JSON.parse(borrowerId);
                } catch (e) {
                    alert("Error: Invalid reservation data. Please rescan the Transaction QR.");
                    return;
                }

                if (transaction.action !== 'RESERVE' || !keyData || keyData.status !== 'AVAILABLE') {
                    alert("Error: Key is not available or the reservation data is invalid.");
                    return;
                }

                // --- VALIDATION: Check if reservation time is still valid (in the future) ---
                if (new Date(transaction.reservationStart) < new Date()) {
                    alert("Error: Reservation start time has already passed. Please process as IMMEDIATE CHECKOUT instead.");
                    return;
                }

                setIsUpdating(true);
                try {
                    await signInAdmin();

                    const updates = {
                        status: 'RESERVED',
                        reservedBy: transaction.borrowerId,
                        reservationStart: transaction.reservationStart,
                        reservationEnd: transaction.reservationEnd,
                    };
                    await writeKeyStatus(selectedKeyId, updates);

                    await database.ref('Logs').push({
                        action: 'RESERVE',
                        keyId: selectedKeyId,
                        borrowerId: transaction.borrowerId,
                        start: transaction.reservationStart,
                        end: transaction.reservationEnd,
                        timestamp: new Date().toISOString(),
                    });

                    alert(`Key ${keyData.name} RESERVED for ID ${transaction.borrowerId} from ${formatTime(transaction.reservationStart)} to ${formatTime(transaction.reservationEnd)}.`);
                    setBorrowerId(''); // Clear state
                    setSelectedKeyId(''); // Clear selected key to reset form

                } catch (error) {
                    console.error("Reservation failed:", error);
                    alert('Reservation Failed: ' + error.message);
                } finally {
                    setIsUpdating(false);
                }
            };

            // --- RETURN LOGIC (UNCHANGED) ---
            const handleReturn = async () => {
                // ... (handleReturn logic is UNCHANGED) ...
                if (!confirm(`Are you sure you want to mark ${keyData.name} as returned?`)) return;

                setIsUpdating(true);
                try {
                    await signInAdmin();
                    const updates = {
                        status: 'AVAILABLE',
                        holderId: null,
                        checkoutTime: null,
                        expectedReturnTime: null,
                        reservedBy: null, // Clear reservation fields too
                        reservationStart: null,
                        reservationEnd: null,
                    };
                    await writeKeyStatus(selectedKeyId, updates);

                    await database.ref('Logs').push({
                        action: 'RETURN',
                        keyId: selectedKeyId,
                        borrowerId: keyData.holderId || keyData.reservedBy,
                        timestamp: new Date().toISOString(),
                    });

                    alert(`Key ${keyData.name} marked as AVAILABLE.`);
                    setBorrowerId('');

                } catch (error) {
                    console.error("Return failed:", error);
                    alert('Return Failed: ' + error.message);
                } finally {
                    setIsUpdating(false);
                }
            };


            // --- EDIT & DELETE LOGIC (UNCHANGED) ---
            const handleEdit = async (e) => { /* ... (UNCHANGED) ... */ };
            const handleDelete = async () => { /* ... (UNCHANGED) ... */ };


            // --- RENDER (JSX) BLOCK HERE ---
            return (
                <div className="p-6 bg-white shadow-2xl rounded-2xl space-y-6">
                    <h3 className="text-3xl font-bold text-teal-800 border-b pb-3 mb-4">Key Management Action Center</h3>

                    {/* üõë IMPROVED UX STEP 1: QR SCANNER/MANUAL SELECTION */}
                    <div className="space-y-4">
                        <div className="p-4 border border-teal-200 bg-teal-50 rounded-xl shadow-inner">
                            <h4 className="text-xl font-extrabold text-teal-800 mb-3">1. Scan or Select Key/Borrower</h4>
                            <p className="text-sm text-gray-700 mb-4">Start by scanning the **Transaction QR** (Borrower App) or the **Key QR** (Asset Tag).</p>

                            {/* QR SCANNER */}
                            <div className="mb-4">
                                <QrScanner onScanSuccess={handleScan} />
                            </div>

                            {/* MANUAL KEY SELECTION */}
                            <label className="block space-y-2 pt-2 border-t border-teal-300">
                                <span className="text-lg text-gray-700 font-bold">Manual Key Selection:</span>
                                <select
                                    value={selectedKeyId}
                                    onChange={(e) => setSelectedKeyId(e.target.value)}
                                    className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg bg-white focus:ring-teal-500 focus:border-teal-500"
                                >
                                    <option value="">-- Select a Key --</option>
                                    {Object.keys(keys).map(id => (
                                        <option key={id} value={id}>
                                            {keys[id].name} - ({keys[id].status})
                                        </option>
                                    ))}
                                </select>
                            </label>
                        </div>
                    </div>

                    {/* üõë IMPROVED UX STEP 2: CHECKOUT / RETURN / RESERVE ACTIONS */}
                    {selectedKeyId && keyData ? (
                        <>
                            {/* CASE 1: Key is currently OUT or RESERVED */}
                            {(isOut || isReserved) ? (
                                <div className={`p-5 rounded-xl shadow-lg ${isReserved ? 'bg-purple-100 border-4 border-purple-500' : 'bg-red-100 border-4 border-red-500'}`}>
                                    <h4 className="text-2xl font-extrabold text-red-800 mb-2">Key Status: {keyData.status}</h4>

                                    {isReserved ? (
                                        <>
                                            <p className="text-xl font-bold text-purple-800 mb-2">Reserved By: ID {keyData.reservedBy}</p>
                                            <p className="text-md text-gray-700">From: {formatTime(keyData.reservationStart)} To: {formatTime(keyData.reservationEnd)}</p>
                                            <p className="text-md text-gray-700 font-bold mt-2">Key will be unavailable during this time.</p>
                                        </>
                                    ) : (
                                        <>
                                            <p className="text-xl font-bold text-red-800 mb-2">Key is currently OUT to ID {keyData.holderId}</p>
                                            <p className="text-md text-gray-700">Due: {expectedTime}</p>
                                        </>
                                    )}

                                    {/* The RETURN button is still the only available action for an out/reserved key */}
                                    <button
                                        onClick={handleReturn}
                                        className="w-full bg-emerald-700 text-white p-4 rounded-xl font-bold mt-4 text-lg hover:bg-emerald-800 transition shadow-md"
                                        disabled={isUpdating}
                                    >
                                        {isUpdating ? 'Processing Return...' : 'Mark Key as RETURNED'}
                                    </button>
                                </div>
                            ) : (
                                /* CASE 2: CURRENTLY AVAILABLE: Show CHECKOUT or RESERVE form */
                                <form onSubmit={handleCheckout} className="p-5 bg-emerald-100 rounded-xl border-4 border-emerald-500 shadow-lg space-y-5">
                                    {/* Determine if the scanned data is a reservation payload */}
                                    {(() => {
                                        let txn = null;
                                        try {
                                            txn = JSON.parse(borrowerId);
                                        } catch (e) {
                                            // Not JSON, continue to standard form below
                                        }

                                        if (txn && txn.action === 'RESERVE') {
                                            // üõë RESERVATION CONFIRMATION BUTTON
                                            return (
                                                <div className="space-y-4">
                                                    <h4 className="text-2xl font-extrabold text-purple-800">RESERVATION Confirmation</h4>
                                                    <p className="text-lg font-bold text-gray-700">Key: {keyData.name}</p>
                                                    <p className="text-lg font-bold text-gray-700">For ID: {txn.borrowerId}</p>
                                                    <p className="text-lg font-bold text-gray-700">Time: {formatTime(txn.reservationStart)} - {formatTime(txn.reservationEnd)}</p>
                                                    <p className="text-sm text-gray-600">This key is available now, and will be reserved until the time above.</p>

                                                    <button
                                                        type="button"
                                                        onClick={handleReserve}
                                                        className="w-full bg-purple-600 text-white p-4 rounded-xl font-bold text-lg hover:bg-purple-700 transition shadow-md"
                                                        disabled={isUpdating}
                                                    >
                                                        {isUpdating ? 'Processing...' : 'PROCESS RESERVATION'}
                                                    </button>
                                                </div>
                                            );
                                        }

                                        // üõë STANDARD IMMEDIATE CHECKOUT FORM (Including Transaction Checkout)
                                        return (
                                            <>
                                                <h4 className="text-2xl font-extrabold text-emerald-800">2. Key Checkout Action</h4>

                                                <label className="block space-y-2">
                                                    <span className="text-lg text-gray-700 font-bold">Borrower ID (Scan or Type):</span>
                                                    <input
                                                        type="text"
                                                        // If JSON CHECKOUT payload is present, show the borrower ID for confirmation
                                                        value={txn && txn.action === 'CHECKOUT' ? txn.borrowerId : borrowerId}
                                                        onChange={(e) => setBorrowerId(e.target.value.toUpperCase().replace(/\s/g, ''))}
                                                        placeholder="Enter Student/Faculty ID"
                                                        className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg focus:ring-teal-500 focus:border-teal-500"
                                                        required
                                                        minLength={4}
                                                        // Lock the input if a CHECKOUT QR was scanned
                                                        disabled={txn && txn.action === 'CHECKOUT'}
                                                    />
                                                </label>

                                                <label className="block space-y-2">
                                                    <span className="text-lg text-gray-700 font-bold">Duration (Hours):</span>
                                                    <select
                                                        // If JSON CHECKOUT payload is present, use that duration
                                                        value={txn && txn.action === 'CHECKOUT' ? txn.duration : duration}
                                                        onChange={(e) => setDuration(parseInt(e.target.value))}
                                                        className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg bg-white"
                                                        disabled={txn && txn.action === 'CHECKOUT'} // Lock if QR was scanned
                                                    >
                                                        <option value={1}>1 Hour</option>
                                                        <option value={2}>2 Hours</option>
                                                        <option value={4}>4 Hours</option>
                                                        <option value={8}>8 Hours (Full Day)</option>
                                                    </select>
                                                </label>

                                                <button
                                                    type="submit"
                                                    className="w-full bg-teal-700 text-white p-4 rounded-xl font-bold text-lg hover:bg-teal-800 transition shadow-md"
                                                    disabled={isUpdating}
                                                >
                                                    {isUpdating ? 'Processing...' : 'CHECKOUT Key'}
                                                </button>
                                            </>
                                        );
                                    })()}
                                </form>
                            )}

                            {/* üõë IMPROVED UX STEP 3: ADMIN KEY UTILITIES (EDIT/DELETE) */}
                            <h4 className="text-2xl font-extrabold text-teal-800 border-b pb-2">3. Key Utility Actions</h4>

                            {/* Edit/Delete Section */}
                            <div className="mt-6 flex space-x-4">
                                <button
                                    onClick={() => setEditMode(!editMode)}
                                    className="flex-1 bg-yellow-600 text-white p-3 rounded-xl font-bold hover:bg-yellow-700 transition shadow-md"
                                    disabled={isUpdating || !keyData}
                                >
                                    {editMode ? 'Cancel Edit' : 'Edit Key Details'}
                                </button>
                                <button
                                    onClick={handleDelete}
                                    className="flex-1 bg-red-600 text-white p-3 rounded-xl font-bold hover:bg-red-700 transition shadow-md"
                                    disabled={isUpdating || !keyData}
                                >
                                    Delete Key
                                </button>
                            </div>

                            {editMode && (
                                <form onSubmit={handleEdit} className="p-5 bg-yellow-100 rounded-xl border-4 border-yellow-500 shadow-lg space-y-5">
                                    <h4 className="text-2xl font-extrabold text-yellow-800">Editing: {keyData.name}</h4>

                                    <label className="block space-y-2">
                                        <span className="text-lg text-gray-700 font-bold">Key Name:</span>
                                        <input
                                            type="text"
                                            value={editName}
                                            onChange={(e) => setEditName(e.target.value)}
                                            className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg focus:ring-teal-500 focus:border-teal-500"
                                            required
                                        />
                                    </label>
                                    {/* ... (rest of edit form is UNCHANGED) ... */}
                                    <label className="block space-y-2">
                                        <span className="text-lg text-gray-700 font-bold">Location:</span>
                                        <input
                                            type="text"
                                            value={editLocation}
                                            onChange={(e) => setEditLocation(e.target.value)}
                                            className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg focus:ring-teal-500 focus:border-teal-500"
                                            required
                                        />
                                    </label>

                                    <button
                                        type="submit"
                                        className="w-full bg-yellow-700 text-white p-4 rounded-xl font-bold text-lg hover:bg-yellow-800 transition shadow-md"
                                        disabled={isUpdating}
                                    >
                                        {isUpdating ? 'Saving...' : 'Save Changes'}
                                    </button>
                                </form>
                            )}
                        </>
                    ) : (
                        <p className="text-center text-xl font-semibold text-gray-500 py-4">Scan a Key or select one above to begin a transaction.</p>
                    )}
                </div>
            );
        };

        // Function I: QrScanner (Handles Camera AND File Input)

        // --- QR SCANNER COMPONENT (Wrapper for the html5-qrcode library) ---
        const QrScanner = ({ onScanSuccess }) => {
            const qrCodeRegionId = 'reader-area';
            const [isScanning, setIsScanning] = useState(false);
            const html5QrCode = useRef(null);
            const fileInputRef = useRef(null); // Ref for the file input element

            useEffect(() => {
                // Initialize the scanner object only once
                if (!html5QrCode.current) {
                    html5QrCode.current = new Html5Qrcode(qrCodeRegionId);
                }
                
                return () => {
                    // Clean up the camera feed when the component unmounts
                    if (html5QrCode.current && html5QrCode.current.isScanning) {
                        html5QrCode.current.stop().catch(err => {
                            console.error("Error stopping scanner on unmount:", err);
                        });
                    }
                };
            }, []); // Empty dependency array ensures this runs once

            const startScanning = () => {
                const config = { 
                    fps: 10, 
                    qrbox: { width: 250, height: 250 } 
                };

                const onScan = (decodedText, decodedResult) => {
                    stopScanning();
                    console.log("QR Code scanned successfully:", decodedText);
                    onScanSuccess(decodedText); 
                };

                html5QrCode.current.start(
                    { facingMode: "environment" }, 
                    config, 
                    onScan, 
                    (errorMessage) => { 
                        // Suppress constant error warnings in console
                    }
                ).then(() => {
                    setIsScanning(true);
                }).catch(err => {
                    console.error("Error starting camera:", err);
                    alert("Could not start camera. Please ensure camera access is granted or use the Upload QR option.");
                });
            };

            const stopScanning = () => {
                if (html5QrCode.current && html5QrCode.current.isScanning) {
                    html5QrCode.current.stop().then(() => {
                        setIsScanning(false);
                    }).catch(err => {
                        console.error("Error stopping the scanner:", err);
                    });
                }
            };
            
            // NEW FUNCTION: Handle file selection and initiate scan from image
            const onFileSelected = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                // Use the html5-qrcode's built-in scan file function
                html5QrCode.current.scanFile(file, true)
                    .then(decodedText => {
                        alert("QR Code image scanned successfully!");
                        // Pass the result back to the management panel
                        onScanSuccess(decodedText); 
                        // Clear file input so the same file can be scanned again if needed
                        fileInputRef.current.value = ''; 
                    })
                    .catch(err => {
                        alert("Error scanning file: Could not detect a valid QR code in the image.");
                        console.error("File scan error:", err);
                        fileInputRef.current.value = '';
                    });
            };

            // The component only needs a single div element to host the camera feed
            return (
                <div className="p-4 bg-gray-100 rounded-lg">
                    <h4 className="text-lg font-bold text-gray-800 mb-2">Scan QR Code</h4>
                    
                    {/* The live camera feed area */}
                    <div id={qrCodeRegionId} className={`w-full h-64 border-2 border-dashed rounded-lg overflow-hidden ${isScanning ? 'border-red-500' : 'border-gray-300'}`}>
                        {/* Camera view will render here */}
                    </div>
                    
                    <div className="flex space-x-2 mt-2">
                        {/* Button to toggle live camera scanning */}
                        <button 
                            onClick={isScanning ? stopScanning : startScanning}
                            className="flex-1 bg-blue-500 text-white p-2 rounded font-bold hover:bg-blue-600 transition"
                        >
                            {isScanning ? 'Stop Live Scan' : 'Start Live Scan'}
                        </button>

                        {/* NEW: Button and input for file upload */}
                        <button 
                            onClick={() => fileInputRef.current.click()}
                            className="flex-1 bg-gray-600 text-white p-2 rounded font-bold hover:bg-gray-700 transition"
                            disabled={isScanning}
                        >
                            Upload QR Image
                        </button>
                    </div>
                    
                    {/* Hidden file input element */}
                    <input 
                        type="file" 
                        accept="image/*" 
                        onChange={onFileSelected} 
                        ref={fileInputRef} 
                        style={{ display: 'none' }} 
                    />

                    <p className="text-sm text-gray-500 mt-2 text-center">
                        Use Live Scan at the counter, or Upload Image for remote requests.
                    </p>
                </div>
            );
        };



        // Function I-2: KeyCreator (Handles Admin form for adding new keys)

        const KeyCreator = () => {
            const [newKeyId, setNewKeyId] = useState('');
            const [newKeyName, setNewKeyName] = useState('');
            const [newKeyLocation, setNewKeyLocation] = useState('');
            const [isCreating, setIsCreating] = useState(false);

            const handleCreate = async (e) => {
                e.preventDefault();
                if (!newKeyId || !newKeyName || !newKeyLocation) {
                    alert("All fields are required to create a new key.");
                    return;
                }

                setIsCreating(true);
                try {
                    // Ensure admin is signed in before write (safety check)
                    await signInAdmin();

                    // Write the new key data using the helper function
                    await writeNewKey(
                        newKeyId.toUpperCase().replace(/\s/g, '_'), // Standardize the ID format
                        newKeyName,
                        newKeyLocation
                    );

                    alert(`New Key '${newKeyName}' created successfully!`);

                    // Clear the form
                    setNewKeyId('');
                    setNewKeyName('');
                    setNewKeyLocation('');

                } catch (error) {
                    console.error("Key creation failed:", error);
                    alert('Key Creation Failed: ' + error.message);
                } finally {
                    setIsCreating(false);
                }
            };

            return (
                <div className="p-5 bg-teal-100 rounded-xl border-4 border-teal-500 shadow-lg space-y-4">
                    <h4 className="text-2xl font-extrabold text-teal-800 border-b pb-2">Add New Key to System</h4>
                    <form onSubmit={handleCreate} className="space-y-4">
                        <input
                            type="text"
                            value={newKeyId}
                            onChange={(e) => setNewKeyId(e.target.value)}
                            placeholder="Enter Unique Key ID (e.g., LAB_3_KEY)"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg text-md focus:ring-teal-500 focus:border-teal-500"
                            required
                        />
                        <input
                            type="text"
                            value={newKeyName}
                            onChange={(e) => setNewKeyName(e.target.value)}
                            placeholder="Key Name (e.g., Classroom 302 Key)"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg text-md focus:ring-teal-500 focus:border-teal-500"
                            required
                        />
                        <input
                            type="text"
                            value={newKeyLocation}
                            onChange={(e) => setNewKeyLocation(e.target.value)}
                            placeholder="Location (e.g., CCS Building)"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg text-md focus:ring-teal-500 focus:border-teal-500"
                            required
                        />
                        <button
                            type="submit"
                            className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold text-lg hover:bg-blue-700 transition shadow-md"
                            disabled={isCreating}
                        >
                            {isCreating ? 'Creating...' : 'Add Key'}
                        </button>
                    </form>
                </div>
            );
        };

        // Function I-3: TransactionHistory (Reads and displays the transaction log)

        const TransactionHistory = () => {
            const [logs, setLogs] = useState([]);
            const [loadingLogs, setLoadingLogs] = useState(true);

            useEffect(() => {
                const logsRef = database.ref('Logs');

                // Order logs by the timestamp and limit to the last 20 entries
                // 'child_added' is efficient for building an ordered list
                logsRef.orderByChild('timestamp').limitToLast(20).on('value', (snapshot) => {
                    const logsArray = [];
                    snapshot.forEach(childSnapshot => {
                        // Push the log data along with its Firebase unique ID
                        logsArray.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });

                    // Reverse the array so the newest log is at the top
                    setLogs(logsArray.reverse());
                    setLoadingLogs(false);
                });

                // Cleanup listener
                return () => logsRef.off();
            }, []);

            if (loadingLogs) {
                return <p className="text-center text-gray-500">Loading Transaction History...</p>;
            }

            if (logs.length === 0) {
                return <p className="text-center text-gray-500">No transactions recorded yet.</p>;
            }

            return (
                <div className="p-5 bg-white shadow-2xl rounded-2xl space-y-4">
                    <h3 className="text-2xl font-bold text-teal-800 border-b pb-2">Recent Transaction Log (Last 20)</h3>

                    <div className="space-y-3 max-h-96 overflow-y-auto">
                        {logs.map((log) => (
                            <div key={log.id} className={`p-3 rounded-lg border-l-4 ${log.action === 'CHECKOUT' ? 'bg-red-50 border-red-500' : 'bg-green-50 border-green-500'}`}>
                                <p className="text-sm font-bold text-gray-800 flex justify-between">
                                    <span>
                                        <span className={`px-2 py-0.5 rounded-full text-xs font-extrabold ${log.action === 'CHECKOUT' ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`}>
                                            {log.action}
                                        </span>
                                        <span className="ml-2 font-extrabold text-teal-800">{log.keyId}</span>
                                    </span>
                                    {/* The robust timestamp display is here */}
                                    <span className="text-xs text-gray-500">
                                        {log.timestamp
                                            ? `${new Date(log.timestamp).toLocaleDateString()} ${formatTime(log.timestamp)}`
                                            : 'N/A'
                                        }
                                    </span>
                                </p>
                                <p className="text-xs mt-1 text-gray-600">
                                    Borrower ID: {log.borrowerId || 'N/A'}
                                    {log.duration && ` | Duration: ${log.duration} hrs`}
                                </p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };


        // Function J-0: BorrowerPortalContents (FINAL VERSION with Reservation and Status View)

        const BorrowerPortalContents = ({ keys, keyArray, loggedInBorrowerId, handleUserLogout }) => {
            // Filter available keys (Keys not 'OUT' or 'RESERVED')
            const availableKeys = keyArray.filter(key => key.status === 'AVAILABLE');
            
            // Form States
            const [selectedKeyId, setSelectedKeyId] = useState('');
            const [requestType, setRequestType] = useState('IMMEDIATE'); // 'IMMEDIATE' or 'RESERVE'
            
            // Immediate Checkout States
            const [duration, setDuration] = useState(2); 

            // Future Reservation States (Date & Time Inputs)
            const [reservationDate, setReservationDate] = useState(new Date().toISOString().substring(0, 10)); // YYYY-MM-DD
            const [startTime, setStartTime] = useState('08:00'); // HH:MM
            const [endTime, setEndTime] = useState('10:00'); // HH:MM

            const [transactionQrData, setTransactionQrData] = useState(null);

            // Helper to get the earliest valid date for reservation (Today)
            const today = new Date().toISOString().substring(0, 10);
            
            // --- TRANSACTION QR GENERATION ---
            const handleGenerateQr = () => {
                if (!selectedKeyId) {
                    alert("Please select a key first.");
                    return;
                }

                let transactionPayload = null;

                if (requestType === 'IMMEDIATE') {
                    if (duration < 1) {
                        alert("Duration must be set for immediate checkout.");
                        return;
                    }
                    // IMMEDIATE CHECKOUT PAYLOAD
                    transactionPayload = {
                        action: "CHECKOUT",
                        keyId: selectedKeyId,
                        borrowerId: loggedInBorrowerId,
                        duration: duration,
                        timestamp: new Date().toISOString(),
                    };

                } else if (requestType === 'RESERVE') {
                    // Combine Date and Time strings into ISO format for server processing
                    const startISO = `${reservationDate}T${startTime}:00Z`; 
                    const endISO = `${reservationDate}T${endTime}:00Z`;

                    if (new Date(startISO) >= new Date(endISO)) {
                        alert("Reservation End Time must be after Start Time.");
                        return;
                    }
                    if (new Date(startISO) < new Date()) {
                        alert("Reservation Start Time must be in the future.");
                        return;
                    }

                    // RESERVATION PAYLOAD
                    transactionPayload = {
                        action: "RESERVE",
                        keyId: selectedKeyId,
                        borrowerId: loggedInBorrowerId,
                        reservationStart: startISO,
                        reservationEnd: endISO,
                        timestamp: new Date().toISOString(),
                    };
                }
                
                // Convert the JSON object to a string for the QR code
                setTransactionQrData(JSON.stringify(transactionPayload));
            };
            
            // Clear QR data if selections or request type change
            useEffect(() => {
                setTransactionQrData(null);
            }, [selectedKeyId, duration, requestType, reservationDate, startTime, endTime]);


            return (
                <div className="p-6 bg-white shadow-2xl rounded-2xl space-y-6">
                    <div className="flex justify-between items-center border-b pb-3">
                        <h2 className="text-3xl font-bold text-green-700">My Borrower Portal</h2>
                        <button onClick={handleUserLogout} className="bg-red-500 text-white p-2 rounded-lg text-sm font-semibold hover:bg-red-600">
                            Log Out
                        </button>
                    </div>
                    <p className="text-xl text-gray-700">
                        Logged in as: <span className="font-extrabold text-green-800">{loggedInBorrowerId}</span>
                    </p>
                    
                    <h3 className="text-2xl font-bold text-gray-800 border-b pb-2">1. Request Configuration</h3>

                    {availableKeys.length === 0 ? (
                        <p className="text-center text-red-500 font-semibold py-4">
                            ‚ö†Ô∏è No keys are currently available for request.
                        </p>
                    ) : (
                        <div className="space-y-4">
                            {/* Key Selection */}
                            <label className="block space-y-2">
                                <span className="text-lg text-gray-700 font-bold">Select Key:</span>
                                <select 
                                    value={selectedKeyId}
                                    onChange={(e) => setSelectedKeyId(e.target.value)}
                                    className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg bg-white focus:ring-green-500 focus:border-green-500"
                                >
                                    <option value="">-- Select Key --</option>
                                    {availableKeys.map(key => (
                                        <option key={key.id} value={key.id}>
                                            {key.name} - ({key.location})
                                        </option>
                                    ))}
                                </select>
                            </label>

                            {/* Request Type Toggle */}
                            <div className="flex space-x-2">
                                <button
                                    onClick={() => setRequestType('IMMEDIATE')}
                                    className={`flex-1 p-3 rounded-xl font-bold transition shadow-md ${requestType === 'IMMEDIATE' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    Immediate Checkout
                                </button>
                                <button
                                    onClick={() => setRequestType('RESERVE')}
                                    className={`flex-1 p-3 rounded-xl font-bold transition shadow-md ${requestType === 'RESERVE' ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    Future Reservation
                                </button>
                            </div>

                            {/* Conditional Input Forms */}
                            {requestType === 'IMMEDIATE' ? (
                                <label className="block space-y-2 pt-2">
                                    <span className="text-lg text-gray-700 font-bold">Duration (Hours):</span>
                                    <select 
                                        value={duration} 
                                        onChange={(e) => setDuration(parseInt(e.target.value))}
                                        className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg bg-white"
                                    >
                                        <option value={1}>1 Hour</option>
                                        <option value={2}>2 Hours</option>
                                        <option value={4}>4 Hours</option>
                                        <option value={8}>8 Hours (Full Day)</option>
                                    </select>
                                </label>
                            ) : (
                                <div className="space-y-4 p-4 bg-purple-50 rounded-lg border border-purple-300">
                                    <h4 className="font-extrabold text-purple-800">Reservation Details</h4>
                                    <label className="block space-y-2">
                                        <span className="text-lg text-gray-700 font-bold">Date:</span>
                                        <input
                                            type="date"
                                            value={reservationDate}
                                            onChange={(e) => setReservationDate(e.target.value)}
                                            min={today}
                                            className="w-full p-3 border-2 border-gray-300 rounded-lg"
                                            required
                                        />
                                    </label>
                                    <div className="flex space-x-4">
                                        <label className="block space-y-2 flex-1">
                                            <span className="text-lg text-gray-700 font-bold">Start Time:</span>
                                            <input
                                                type="time"
                                                value={startTime}
                                                onChange={(e) => setStartTime(e.target.value)}
                                                className="w-full p-3 border-2 border-gray-300 rounded-lg"
                                                required
                                            />
                                        </label>
                                        <label className="block space-y-2 flex-1">
                                            <span className="text-lg text-gray-700 font-bold">End Time:</span>
                                            <input
                                                type="time"
                                                value={endTime}
                                                onChange={(e) => setEndTime(e.target.value)}
                                                className="w-full p-3 border-2 border-gray-300 rounded-lg"
                                                required
                                            />
                                        </label>
                                    </div>
                                </div>
                            )}
                            
                            <button
                                onClick={handleGenerateQr}
                                disabled={!selectedKeyId || (requestType === 'IMMEDIATE' && duration < 1)}
                                className={`w-full p-3 rounded-xl font-semibold transition shadow-md disabled:bg-gray-400 ${requestType === 'IMMEDIATE' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-purple-600 hover:bg-purple-700'} text-white`}
                            >
                                Generate {requestType} QR Code
                            </button>
                        </div>
                    )}
                    
                    {/* Display the generated QR code */}
                    {transactionQrData && (
                        <>
                            <h3 className="text-2xl font-bold text-gray-800 border-b pb-2 pt-4">2. Transaction QR Code</h3>
                            
                            <QrGenerator 
                                data={transactionQrData} 
                                name={`TXN_${loggedInBorrowerId}_${requestType}`} 
                                size={250}
                            />

                            <div className="p-4 bg-green-50 rounded-xl text-sm text-green-800 border border-green-300">
                                <p className="font-semibold">Instruction:</p>
                                <p>Show this single QR code to the key keeper at the counter, or **Download and send the image** digitally to the admin for remote processing.</p>
                            </div>
                        </>
                    )}

                    {/* üõë NEW: 3. BORROWER'S CURRENT STATUS AND HISTORY */}
                    <h3 className="text-2xl font-bold text-gray-800 border-b pb-2 pt-4">3. My Current Key Status</h3>
                    
                    {/* Filter keys relevant to the logged-in user */}
                    {keyArray.filter(key => key.holderId === loggedInBorrowerId || key.reservedBy === loggedInBorrowerId).length > 0 ? (
                        
                        <div className="space-y-4">
                            {keyArray
                                .filter(key => key.holderId === loggedInBorrowerId || key.reservedBy === loggedInBorrowerId)
                                .map(key => (
                                    <div key={key.id} className={`p-4 rounded-xl shadow-md ${key.status === 'OUT' ? 'bg-red-50 border border-red-400' : 'bg-purple-50 border border-purple-400'}`}>
                                        <p className="text-xl font-extrabold text-teal-800">{key.name}</p>
                                        
                                        <p className="font-bold mt-1">Status: 
                                            <span className={`px-2 py-0.5 rounded-full text-xs font-extrabold ml-2 ${key.status === 'OUT' ? 'bg-red-200 text-red-800' : 'bg-purple-200 text-purple-800'}`}>
                                                {key.status}
                                            </span>
                                        </p>
                                        
                                        {key.status === 'OUT' && (
                                            <p className="text-sm mt-1">Due: {formatTime(key.expectedReturnTime)}</p>
                                        )}
                                        {key.status === 'RESERVED' && (
                                            <p className="text-sm mt-1">Reserved Time: {formatTime(key.reservationStart)} - {formatTime(key.reservationEnd)}</p>
                                        )}
                                    </div>
                                ))}
                        </div>
                        
                    ) : (
                        <p className="text-center text-gray-500 py-4">You have no keys currently checked out or reserved.</p>
                    )}
                </div>
            );
        };
        // Function J: UserAuth (Handles Registration and Login)

        const UserAuth = ({ onLoginSuccess }) => {
            const [isRegistering, setIsRegistering] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [borrowerId, setBorrowerId] = useState(''); // NEW: The Student/Faculty ID
            const [isProcessing, setIsProcessing] = useState(false);
            const [error, setError] = useState('');

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                setIsProcessing(true);

                try {
                    if (isRegistering) {
                        // 1. Create User in Firebase Authentication
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);

                        // 2. Store user data (Borrower ID) in Firebase Realtime Database
                        await database.ref(`Borrowers/${userCredential.user.uid}`).set({
                            email: email,
                            borrowerId: borrowerId.toUpperCase(), // Standardize ID format
                            createdAt: new Date().toISOString(),
                        });

                        alert('Registration successful! Please log in.');
                        setIsRegistering(false); // Switch to login after registration

                    } else {
                        // 1. Sign In User
                        const userCredential = await auth.signInWithEmailAndPassword(email, password);

                        // 2. Fetch the corresponding Borrower ID from the database
                        const snapshot = await database.ref(`Borrowers/${userCredential.user.uid}/borrowerId`).once('value');
                        const loggedInBorrowerId = snapshot.val();

                        if (loggedInBorrowerId) {
                            onLoginSuccess(userCredential.user, loggedInBorrowerId); // Pass user and ID back to App
                        } else {
                            // This happens if the user exists in Auth but not in Realtime DB (corrupted)
                            throw new Error("Borrower ID not found. Please contact admin.");
                        }
                    }
                } catch (err) {
                    console.error("Authentication failed:", err);
                    setError(err.message);
                } finally {
                    setIsProcessing(false);
                }
            };

            return (
                <div className="max-w-md mx-auto p-6 mt-10 bg-white shadow-2xl rounded-xl space-y-4">
                    <h2 className="text-3xl font-bold text-teal-800 text-center">
                        {isRegistering ? 'New Borrower Registration' : 'Borrower Login'}
                    </h2>

                    <form onSubmit={handleAuth} className="space-y-4">
                        {isRegistering && (
                            <input
                                type="text"
                                value={borrowerId}
                                onChange={(e) => setBorrowerId(e.target.value.toUpperCase().replace(/\s/g, ''))}
                                placeholder="Student/Faculty ID (e.g., S2022-001)"
                                className="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required={isRegistering}
                                minLength={4}
                            />
                        )}
                        <input
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            placeholder="Email Address"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            required
                        />
                        <input
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            placeholder="Password (min 6 characters)"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            required
                            minLength={6}
                        />

                        {error && <p className="text-red-600 text-sm">{error}</p>}

                        <button
                            type="submit"
                            className="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-md"
                            disabled={isProcessing}
                        >
                            {isProcessing ? 'Processing...' : isRegistering ? 'Register & Create Account' : 'Log In'}
                        </button>
                    </form>

                    <button
                        onClick={() => setIsRegistering(!isRegistering)}
                        className="w-full text-sm text-gray-500 hover:text-teal-700"
                        disabled={isProcessing}
                    >
                        {isRegistering ? 'Already have an account? Login here.' : 'Need to register? Create an account.'}
                    </button>
                </div>
            );
        };


        // Function K-1: QrCodeCanvas (The isolated engine that handles the pure JS library)

        const QrCodeCanvas = ({ data, size }) => {
            const qrContainerRef = useRef(null);

            // This useEffect handles the pure JavaScript drawing and cleanup.
            useEffect(() => {
                // 1. Check if the global QrCode constructor is available
                if (typeof window.QRCode === 'undefined' || !qrContainerRef.current) {
                    return;
                }

                // 2. Clear the container before drawing a new code (CRITICAL FIX)
                // This ensures the old drawing is removed before the new one is added,
                // preventing the DOMException error.
                qrContainerRef.current.innerHTML = '';

                // 3. Draw the QR code
                new window.QRCode(qrContainerRef.current, {
                    text: data || 'No Data',
                    width: size,
                    height: size,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: window.QRCode.CorrectLevel.H
                });

            }, [data, size]);

            // Renders only the container div for the JavaScript library to use.
            // We add a specific class for the download function to easily find the canvas.
            return <div ref={qrContainerRef} className="qr-canvas-container" />;
        }


        // Function K: QrGenerator (The UI wrapper that controls the download logic)

        const QrGenerator = ({ data, size = 200, name = 'Code' }) => {

            const [qrReady, setQrReady] = useState(false);

            // Check for library readiness and enable the download button
            useEffect(() => {
                // Set a slight delay to confirm drawing has finished before enabling download
                const timer = setTimeout(() => {
                    setQrReady(typeof window.QRCode !== 'undefined');
                }, 300);
                return () => clearTimeout(timer);
            }, [data]);


            // Helper function to handle the download (Grabs the canvas from the container)
            const handleDownload = () => {
                // Query the DOM for the canvas element created inside the QrCodeCanvas component
                const canvas = document.querySelector('.qr-canvas-container canvas');
                if (canvas) {
                    const dataURL = canvas.toDataURL('image/png');
                    const a = document.createElement('a');
                    a.href = dataURL;
                    a.download = `${name}_QR_Code.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }
            };


            return (
                <div className="flex flex-col items-center p-4 bg-white rounded-xl shadow-inner border border-gray-200">
                    <h4 className="text-lg font-bold text-gray-700 mb-2">QR Code for: {name}</h4>

                    <div className="p-1 mb-3 border border-gray-300 w-fit h-fit">
                        {/* Use the isolated component here */}
                        {qrReady ? (
                            <QrCodeCanvas data={data} size={size} />
                        ) : (
                            <p className="text-red-500">QR Generator is loading...</p>
                        )}
                    </div>

                    <button
                        onClick={handleDownload}
                        className={`w-full text-center p-2 rounded-lg font-semibold transition shadow-md ${qrReady ? 'bg-teal-600 text-white hover:bg-teal-700' : 'bg-gray-400 text-gray-700 cursor-not-allowed'}`}
                        disabled={!qrReady}
                    >
                        {qrReady ? 'Download QR Code' : 'Generating...'}
                    </button>

                    <p className="text-xs mt-2 text-gray-500">
                        Data: <span className="font-mono text-teal-800 break-all">{data}</span>
                    </p>
                </div>
            );
        };

        // Function G-2 : AdminPortal (Updated for Thematic Separation)

        // --- ADMIN PORTAL COMPONENT (Handles Login Gate) ---
        // üõë FIX: Ensure keyArray is accepted as a prop
        const AdminPortal = ({ keys, keyArray }) => {
            // State to manage input and authentication status
            const [passcode, setPasscode] = useState('');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isSigningIn, setIsSigningIn] = useState(false);
            const [selectedKeyId, setSelectedKeyId] = useState(() => Object.keys(keys).find(id => keys[id] && keys[id].name) || Object.keys(keys)[0] || '');
            // NEW STATE: To select which key to generate a QR code for
            const [selectedKeyForQr, setSelectedKeyForQr] = useState('');

            // Logic to attempt sign-in and password check
            const handleLogin = async (e) => {
                e.preventDefault();
                // Prototype Password Check: Simple security gate
                if (passcode !== 'CCS2025') {
                    alert('Invalid Passcode. Use CCS2025');
                    return;
                }
                setIsSigningIn(true);
                try {
                    // Signs the user into Firebase anonymously to grant write permission
                    await signInAdmin();
                    setIsAuthenticated(true);
                } catch (error) {
                    alert('Authentication Failed: ' + error.message);
                } finally {
                    setIsSigningIn(false);
                }
            };

            if (!isAuthenticated) {
                // --- LOGIN SCREEN RENDER: (UNCHANGED) ---
                return (
                    // NEW: Darker background for the login box
                    <div className="max-w-xs mx-auto p-6 mt-10 bg-teal-800 shadow-2xl rounded-xl">
                        <h2 className="text-xl font-bold text-white mb-4 text-center">Key Keeper Login</h2>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input
                                type="password"
                                value={passcode}
                                onChange={(e) => setPasscode(e.target.value.toUpperCase())}
                                placeholder="Enter Passcode (CCS2025)"
                                // Input colors adjusted for dark background
                                className="w-full p-3 border border-teal-600 rounded-lg focus:ring-blue-500 text-teal-900 placeholder-gray-500"
                                disabled={isSigningIn}
                            />
                            <button
                                type="submit"
                                // Button uses the bright, active TEAL-600 color
                                className="w-full bg-teal-600 text-white p-3 rounded-lg font-semibold hover:bg-teal-700 transition shadow-lg"
                                disabled={isSigningIn}
                            >
                                {isSigningIn ? 'Signing In...' : 'Access Portal'}
                            </button>
                        </form>
                    </div>
                );
            }

            // If authenticated, render the full Admin Portal
            return (
                <div className="space-y-6">

                    {/* Key Creation Component */}
                    <KeyCreator />

                    {/* Checkout/Return Forms */}
                    <KeyManagementPanel keys={keys} selectedKeyId={selectedKeyId} setSelectedKeyId={setSelectedKeyId} />

                    {/* Transaction History Viewer */}
                    <TransactionHistory />

                    {/* üõë NEWLY MOVED: ADMIN KEY QR GENERATOR SECTION */}
                    {keyArray.length > 0 && (
                        <div className="p-6 bg-white shadow-2xl rounded-2xl space-y-6">
                            <h3 className="text-3xl font-bold text-teal-800 border-b pb-3">Key QR Code Generator</h3>
                            <p className="text-sm text-gray-600">Select a key to generate its unique QR code for printing and binding to the physical key.</p>

                            <label className="block space-y-2">
                                <span className="text-lg text-gray-700 font-bold">Select Key ID:</span>
                                <select
                                    value={selectedKeyForQr}
                                    onChange={(e) => setSelectedKeyForQr(e.target.value)}
                                    className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg bg-white"
                                >
                                    <option value="">-- Select Key to Generate QR --</option>
                                    {keyArray.map(key => (
                                        <option key={key.id} value={key.id}>
                                            {key.name} - ({key.id})
                                        </option>
                                    ))}
                                </select>
                            </label>

                            {selectedKeyForQr && (
                                <QrGenerator
                                    data={selectedKeyForQr}
                                    name={`${keys[selectedKeyForQr].name}_KEY`}
                                />
                            )}

                            <div className="p-4 bg-teal-50 rounded-xl text-sm text-teal-800">
                                <p className="font-semibold">Key Binding Note:</p>
                                <p>The QR code data is the **Key ID** (e.g., `LAB_3_KEY`). If the physical QR code is lost or damaged, you can simply print a new one using the original Key ID from this list. The key's binding remains secure in the database.</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };


        // Function H: The Main App Component (Final Fixed Structure + AUTH)
        const App = () => {
            const [keys, setKeys] = useState({});
            const [loading, setLoading] = useState(true);
            // üõë NEW: 'public', 'admin', 'user' (logged-in borrower)
            const [viewMode, setViewMode] = useState('public');
            const [currentTime, setCurrentTime] = useState(new Date());

            // üõë NEW AUTH STATES
            const [loggedInUser, setLoggedInUser] = useState(null); // Firebase User Object
            const [loggedInBorrowerId, setLoggedInBorrowerId] = useState(null); // Student/Faculty ID
            const [selectedKeyForQr, setSelectedKeyForQr] = useState(''); // State for Admin QR Generator

            // üõë NEW LOGIN HANDLER
            const handleUserLogin = (user, borrowerId) => {
                setLoggedInUser(user);
                setLoggedInBorrowerId(borrowerId);
                setViewMode('user'); // Switch to the user portal view
                alert(`Welcome, ID ${borrowerId}. You are now logged in.`);
            };

            // üõë NEW LOGOUT HANDLER
            const handleUserLogout = () => {
                auth.signOut();
                setLoggedInUser(null);
                setLoggedInBorrowerId(null);
                setViewMode('public');
                alert('You have been logged out.');
            };


            // Effect 1: Clock (Drives Countdown and Public Time)
            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            // Effect 2: Firebase Data Fetching
            useEffect(() => {
                const keysRef = database.ref('Keys');

                keysRef.on('value', (snapshot) => {
                    const liveData = snapshot.val();

                    if (liveData) {
                        setKeys(liveData);
                    } else {
                        setKeys({});
                    }

                    setLoading(false);
                });

                return () => keysRef.off();
            }, []);

            // CRITICAL FIX: Add defensive check to sorting to prevent "a.name is undefined" error
            const keyArray = Object.keys(keys)
                .map(keyId => ({
                    // Inject the unique Firebase key name as the 'id' property
                    id: keyId,
                    ...keys[keyId] // Spread the rest of the key data (name, location, status, etc.)
                }))
                // Now perform the defensive sort using the guaranteed 'name' property
                .sort((a, b) => {
                    const nameA = a.name || '';
                    const nameB = b.name || '';
                    return nameA.localeCompare(nameB);
                });


            // Conditional Loading Check (Uses the themed spinner)
            if (loading) return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-8">
                    <div className="w-12 h-12 border-4 border-teal-500 border-t-transparent border-solid rounded-full animate-spin"></div>
                    <p className="mt-4 text-lg font-semibold text-teal-700">
                        Establishing Realtime Connection...
                    </p>
                    <p className="mt-1 text-sm text-gray-500">
                        Fetching latest key status from the server.
                    </p>
                </div>
            );

            // Final Render
            return (
                <div className="min-h-screen bg-gray-100 p-2 sm:p-4 font-sans antialiased">
                    <div className="max-w-xl lg:max-w-2xl mx-auto space-y-6">

                        <header className="py-8 bg-white shadow-lg rounded-b-xl">
                            <h1 className="text-4xl font-extrabold text-teal-800 text-center">
                                KeyFiRoom - LSPU üîë
                            </h1>
                            <p className="text-center text-md text-gray-500 mt-1">
                                Check key availability before heading to the office.
                            </p>
                        </header>

                        {/* View Switcher Buttons */}
                        <div className="flex justify-center space-x-2 p-1 bg-white rounded-xl shadow-inner">
                            <button
                                onClick={() => setViewMode('public')}
                                className={`flex-1 p-3 rounded-xl text-sm sm:text-base font-bold transition focus:outline-none ${viewMode === 'public' ? 'bg-blue-700 text-white shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                            >
                                Public Status
                            </button>
                            {/* üõë Borrower Portal Button */}
                            <button
                                onClick={() => setViewMode('user')}
                                className={`flex-1 p-3 rounded-xl text-sm sm:text-base font-bold transition focus:outline-none ${viewMode === 'user' ? 'bg-green-700 text-white shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                            >
                                Borrower Portal
                            </button>
                            <button
                                onClick={() => setViewMode('admin')}
                                className={`flex-1 p-3 rounded-xl text-sm sm:text-base font-bold transition focus:outline-none ${viewMode === 'admin' ? 'bg-teal-700 text-white shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                            >
                                Admin Action
                            </button>
                        </div>

                        {viewMode === 'public' && (
                            <div className="space-y-4 pt-2">
                                {/* Dynamic Clock Display */}
                                <p className="text-sm font-semibold text-gray-700 px-2 text-center">
                                    Current System Time:
                                    <span className="text-teal-700 ml-2">
                                        {formatTime(currentTime.toISOString())}
                                    </span>
                                </p>
                                <h2 className="text-2xl font-extrabold text-gray-800 px-2">Live Status Feed</h2>

                                {keyArray.length > 0 ? (
                                    keyArray.map(key => (
                                        <KeyStatusRow key={key.id} keyData={key} />
                                    ))
                                ) : (
                                    <p className="text-center text-gray-500">No keys available yet.</p>
                                )}
                            </div>
                        )}

                        {/* üõë USER AUTH/PORTAL LOGIC (UPDATED TO PASS KEYS) */}
                        {viewMode === 'user' && (
                            loggedInUser ? (
                                // Pass keys and borrower ID to the new component
                                <BorrowerPortalContents
                                    keys={keys}
                                    keyArray={keyArray}
                                    loggedInBorrowerId={loggedInBorrowerId}
                                    handleUserLogout={handleUserLogout}
                                />
                            ) : (
                                // Show the login/registration form if not logged in
                                <UserAuth onLoginSuccess={handleUserLogin} />
                            )
                        )}

                        {/* üõë ADMIN PORTAL LOGIC (NOW ONLY CONTAINS THE SINGLE ADMINPORTAL CALL) */}
                        {viewMode === 'admin' && (
                            <AdminPortal keys={keys} keyArray={keyArray} />
                        )}

                        <footer className="text-center text-xs text-gray-400 pt-8 pb-4">
                            Developed by CCS Students. Data updates instantly.
                        </footer>
                    </div>
                </div>
            );
        };


        // --- START THE APP ---

        // --- 3. THE RENDER CALL WILL BE AT THE VERY BOTTOM (React 18 Update) ---

        // NEW: Uses the modern createRoot API to suppress the React 18 deprecation warning
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>

</html>