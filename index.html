<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeyFiRoom - LSPU Status Viewer</title>

    <!-- STYLING: Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FRONT-END: React, Babel, and Firebase SDKs -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- üõë CRITICAL FIX: Reverting to Stable Firebase v8 CDNs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <!-- QR SCANNER (To be used in Week 2) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. CONFIGURATION & GLOBAL SETUP ---
        const firebaseConfig = {
        apiKey: "AIzaSyDFShCL1h1IZ2me-ek79XHqIpaFR2itBrg",
        authDomain: "keyfiroom-lspu.firebaseapp.com",
        databaseURL: "https://keyfiroom-lspu-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "keyfiroom-lspu",
        storageBucket: "keyfiroom-lspu.firebasestorage.app",
        messagingSenderId: "924604537949",
        appId: "1:924604537949:web:210fe3056f9eb0882381b4",
        //measurementId: "G-XEN24RE55T"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth(); 

        // FORCING INITIAL READ TO ENSURE BROWSER GETS DATA
        database.ref('Keys').once('value', (snapshot) => {
        // This line is a temporary check that forces the browser to pull data on load.
        if (snapshot.exists()) {
        console.log("Firebase Read Success!");
        } else {
        console.error("Firebase Read Error: The 'Keys' node is empty or missing.");
        }
        });
        
        const STATIC_KEY_LIST = [
            { id: 'LAB_4_SERVERS', name: 'Lab 4 Server Key', location: 'CCS Building' },
            { id: 'ROOM_305_LECTURE', name: 'Lecture Hall 305 Key', location: 'CCS Building' },
            { id: 'FACULTY_OFFICE_B', name: 'Faculty Office B Key', location: 'Admin Annex' },
            // Add other keys here up to 10...
        ];
        
        const { useState, useEffect } = React;

        // --- 2. JAVASCRIPT/REACT CODE WILL START HERE ---


        // Function A: formatTime (Solves Readability)

            const formatTime = (isoString) => {
            // 1. If the input is empty (e.g., key is AVAILABLE), return N/A text.
            if (!isoString) return 'N/A'; 
            
            // 2. Creates a JavaScript Date object from the messy string.
            const date = new Date(isoString); 
            
            // 3. Converts the Date object into a readable time string.
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: true // Forces it to display AM/PM format
            });
        };

        // Function B: isKeyOverdue (Solves Accountability)

            const isKeyOverdue = (expectedReturnTime) => {
            // 1. If the key is not checked out, it cannot be overdue.
            if (!expectedReturnTime) return false;
    
            // 2. Compares the key's DUE TIME (left) against the CURRENT TIME (right).
            // If Due Time is EARLIER (less than) the current time, the key is overdue.
            return new Date(expectedReturnTime) < new Date();
        };

        // Function C: calculateReturnTime (Solves Duration Hassle)

            const calculateReturnTime = (durationHours) => {
            // 1. Gets the current time right now.
            const now = new Date();
        
            // 2. Adds the requested duration (1, 2, or 4 hours) to the current time.
            now.setHours(now.getHours() + durationHours); 
        
            // 3. Returns the time in the standardized format required by Firebase.
            return now.toISOString();
        };

        // Function D: signInAdmin (Solves Write Permission)

            // --- WRITE HELPERS (For Week 2) ---
            const signInAdmin = () => {
                
            // Required by Firebase security rules to perform the write action
            return auth.signInAnonymously(); 
        };

        // Function E: writeKeyStatus (Solves Data Persistence)

             const writeKeyStatus = (keyId, updates) => {
             // This function sends the data to the correct path in the database
             const keyRef = database.ref(`Keys/${keyId}`); 

            return keyRef.set(updates); 
        };



        // Function I: calculateTimeLeft (Solves User Confusion / Creates Urgency)

        const calculateTimeLeft = (expectedReturnTime) => {
            if (!expectedReturnTime) return null; // Key is available

            const now = new Date();
            const dueTime = new Date(expectedReturnTime);
            const diffMs = dueTime - now; // Difference in milliseconds

            if (diffMs <= 0) {
                // If the difference is zero or negative, return null so the row handles the OVERDUE state
                return null;
            }

            // Calculate hours and minutes
            const diffMins = Math.floor(diffMs / 60000); // Total minutes left
            const hours = Math.floor(diffMins / 60);
            const minutes = diffMins % 60;

            let output = '';
            if (hours > 0) {
                output += `${hours} hr${hours > 1 ? 's' : ''}`;
            }
            if (minutes > 0 || hours === 0) {
                if (output.length > 0) output += ' ';
                output += `${minutes} min${minutes > 1 ? 's' : ''}`;
            }
            
            return output.trim();
        };


        // Function I-1: writeNewKey (Handles creation of a brand new key entry)

        const writeNewKey = (keyId, name, location) => {
            // Data to be written for the new key's status
            const statusUpdates = {
                status: 'AVAILABLE',
                holderId: null,
                checkoutTime: null,
                expectedReturnTime: null,
                // Include static data directly in the key's object
                name: name,
                location: location
            };

            // This overwrites/creates the key at the specified path
            const keyRef = database.ref(`Keys/${keyId}`); 

            return keyRef.set(statusUpdates); 
        };

        // Function F: KeyStatusRow (The Visual Element - Updated for Countdown)
        const KeyStatusRow = ({ keyData }) => {

            const isOut = keyData.status === 'OUT';
            const isOverdue = isKeyOverdue(keyData.expectedReturnTime); 
            // NEW: Calculate time left
            const timeLeft = calculateTimeLeft(keyData.expectedReturnTime);

            const statusColor = isOverdue 
                        ? 'bg-yellow-500 text-red-900 border-2 border-red-700 animate-pulse shadow-xl' 
                        : isOut 
                        ? 'bg-red-700 text-white shadow-md'
                        : 'bg-emerald-600 text-white shadow-md';

            const statusText = isOverdue ? '‚ö†Ô∏è OVERDUE' : keyData.status;

            return (
                <div className="flex flex-col p-5 mb-3 border-none rounded-2xl shadow-xl bg-white transition hover:shadow-2xl">
                    
                    <div className="flex items-center justify-between">
                        <span className="text-2xl font-extrabold text-teal-800">{keyData.name}</span>
                        <span className={`px-4 py-1 text-sm font-bold rounded-full ${statusColor}`}>
                            {statusText}
                        </span>
                    </div>
                
                    <div className="mt-2 text-md text-gray-600">
                        <p>Location: {keyData.location}</p>
                        {isOut && (
                            <>
                                {/* CHANGE: Conditional Display for Countdown vs. Due Time */}
                                <p className={`font-extrabold mt-1 ${isOverdue ? 'text-red-700' : 'text-red-600'}`}>
                                    {isOverdue 
                                        ? 'OVERDUE SINCE: ' + formatTime(keyData.expectedReturnTime)
                                        : timeLeft
                                            ? 'AVAILABLE IN: ' + timeLeft // Display Countdown
                                            : 'DUE BACK: ' + formatTime(keyData.expectedReturnTime) // Fallback or Edge Case
                                    }
                                </p>
                                <p className="text-sm">Checked Out By: ID {keyData.holderId || 'Unknown'}</p>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // Function G-1 : KeyManagementPanel (The Key Keeper Forms and Logic - FIX AND THEME)

        // --- KEY MANAGEMENT PANEL (Handles Checkout/Return Forms and Logic) ---
        const KeyManagementPanel = ({ keys, selectedKeyId, setSelectedKeyId }) => {
            // Finds the current key's status from the main data array
            const keyData = keys[selectedKeyId];
            const [borrowerId, setBorrowerId] = useState('');
            const [duration, setDuration] = useState(2); // Default duration
            const [isUpdating, setIsUpdating] = useState(false);

            const isOut = keyData && keyData.status === 'OUT';
            const expectedTime = keyData && keyData.expectedReturnTime ? formatTime(keyData.expectedReturnTime) : 'N/A';

            // --- QR SCAN HANDLING LOGIC (remains the same) ---
            const handleScan = (scannedText) => { 
                const isBorrowerId = scannedText.length > 5 && !isNaN(scannedText); 
                if (isBorrowerId) {
                    setBorrowerId(scannedText); 
                    alert(`Borrower ID Scanned: ${scannedText}. Please select a duration and CHECKOUT.`);
                } else if (keys[scannedText]) {
                    setSelectedKeyId(scannedText); 
                    alert(`Key ID Scanned: ${keys[scannedText].name} selected.`);
                } else {
                    alert(`Scan failed: Scanned text "${scannedText}" does not match a Key or Borrower ID format.`);
                }
            };

            // --- CHECKOUT LOGIC (Digital Logbook Entry) ---
            const handleCheckout = async (e) => {
                e.preventDefault();
                if (!borrowerId || duration < 1) {
                    alert("Borrower ID and Duration are required.");
                    return;
                }
                if (!keyData || keyData.status === 'OUT') {
                    alert("Error: Key is already checked out.");
                    return;
                }

                setIsUpdating(true);
                try {
                    await signInAdmin(); 
                    const expectedReturnTime = calculateReturnTime(duration);
                    
                    // 1. Update the Key Status (Overwrites the key status)
                    const updates = {
                        status: 'OUT',
                        holderId: borrowerId,
                        checkoutTime: new Date().toISOString(),
                        expectedReturnTime: expectedReturnTime,
                    };
                    await writeKeyStatus(selectedKeyId, updates);

                    // 2. CRITICAL NEW: Create Permanent Log Entry
                    await database.ref('Logs').push({
                        action: 'CHECKOUT',
                        keyId: selectedKeyId,
                        borrowerId: borrowerId,
                        duration: duration,
                        timestamp: new Date().toISOString(),
                        expectedReturnTime: expectedReturnTime,
                    });

                    alert(`Key ${keyData.name} checked out to ID ${borrowerId} until ${formatTime(expectedReturnTime)}.`);
                    setBorrowerId('');

                } catch (error) {
                    console.error("Checkout failed:", error);
                    alert('Checkout Failed: ' + error.message);
                } finally {
                    setIsUpdating(false);
                }
            };

            // --- RETURN LOGIC (Resets status to AVAILABLE) ---
            const handleReturn = async () => {
                if (!confirm(`Are you sure you want to mark ${keyData.name} as returned?`)) return;

                setIsUpdating(true);
                try {
                    await signInAdmin(); 



                    // 1. Update the Key Status
                    const updates = {
                        status: 'AVAILABLE',
                        holderId: null,
                        checkoutTime: null,
                        expectedReturnTime: null,
                    };
                    await writeKeyStatus(selectedKeyId, updates);


                    // 2. CRITICAL NEW: Create Permanent Log Entry for Return
                    await database.ref('Logs').push({
                        action: 'RETURN',
                        keyId: selectedKeyId,
                        borrowerId: keyData.holderId, // Use the ID from the current keyData
                        timestamp: new Date().toISOString(),
                    });

                    alert(`Key ${keyData.name} marked as AVAILABLE.`);
                    setBorrowerId('');

                } catch (error) {
                    console.error("Return failed:", error);
                    alert('Return Failed: ' + error.message);
                } finally {
                    setIsUpdating(false);
                }
            };

            // --- RENDER THE CHECKOUT/RETURN FORM ---
            return (
                <div className="p-6 bg-white shadow-2xl rounded-2xl space-y-6"> 
                    <h3 className="text-3xl font-bold text-teal-800 border-b pb-3 mb-4">Key Management</h3>
                    
                    <div className="p-4 border border-teal-200 bg-teal-50 rounded-xl shadow-inner">
                        <QrScanner onScanSuccess={handleScan} />
                    </div>
                    
                    <label className="block space-y-2">
                        <span className="text-lg text-gray-700 font-bold">Select Key to Manage:</span>
                        <select 
                            value={selectedKeyId} 
                            onChange={(e) => setSelectedKeyId(e.target.value)}
                            className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg bg-white focus:ring-teal-500 focus:border-teal-500"
                        >
                            {Object.keys(keys).map(id => (
                                <option key={id} value={id}>
                                    {keys[id].name} - ({keys[id].status})
                                </option>
                            ))}
                        </select>
                    </label>

                    {keyData && isOut ? (
                        // --- RETURN VIEW (If key is OUT) ---
                        <div className="p-5 bg-red-100 rounded-xl border-4 border-red-500 shadow-lg"> 
                            <p className="text-xl font-bold text-red-800 mb-2">Key is currently OUT to ID {keyData.holderId}</p>
                            <p className="text-md text-gray-700">Due: {expectedTime}</p>
                            <button 
                                onClick={handleReturn}
                                className="w-full bg-emerald-700 text-white p-4 rounded-xl font-bold mt-4 text-lg hover:bg-emerald-800 transition shadow-md"
                                disabled={isUpdating}
                            >
                                {isUpdating ? 'Processing Return...' : 'Mark Key as RETURNED'}
                            </button>
                        </div>
                    ) : (
                        // --- CHECKOUT FORM VIEW (If key is AVAILABLE) ---
                        <form onSubmit={handleCheckout} className="p-5 bg-emerald-100 rounded-xl border-4 border-emerald-500 shadow-lg space-y-5">
                            <h4 className="text-2xl font-extrabold text-emerald-800">Checkout Available Key</h4>
                            
                            <label className="block space-y-2">
                                <span className="text-lg text-gray-700 font-bold">Borrower ID (Scan or Type):</span>
                                <input 
                                    type="text" 
                                    value={borrowerId} 
                                    onChange={(e) => setBorrowerId(e.target.value.toUpperCase().replace(/\s/g, ''))}
                                    placeholder="Enter Student/Faculty ID"
                                    className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg focus:ring-teal-500 focus:border-teal-500" 
                                    required
                                    minLength={4}
                                />
                            </label>

                            <label className="block space-y-2">
                                <span className="text-lg text-gray-700 font-bold">Duration (Hours):</span>
                                <select 
                                    value={duration} 
                                    onChange={(e) => setDuration(parseInt(e.target.value))}
                                    className="w-full p-4 border-2 border-gray-300 rounded-xl text-lg bg-white"
                                >
                                    <option value={1}>1 Hour</option>
                                    <option value={2}>2 Hours</option>
                                    <option value={4}>4 Hours</option>
                                    <option value={8}>8 Hours (Full Day)</option>
                                </select>
                            </label>
                            
                            <button 
                                type="submit" 
                                className="w-full bg-teal-700 text-white p-4 rounded-xl font-bold text-lg hover:bg-teal-800 transition shadow-md"
                                disabled={isUpdating}
                            >
                                {isUpdating ? 'Processing...' : 'CHECKOUT Key'}
                            </button>
                        </form>
                    )}
                </div>
            );
        };

        // Function I: QrScanner (Handles Camera Input - FIX: Cleanup Logic)

        // --- QR SCANNER COMPONENT (Wrapper for the html5-qrcode library) ---
        const QrScanner = ({ onScanSuccess }) => {
            const qrCodeRegionId = 'reader-area';
            
            useEffect(() => {
                // Initialize the instance variable outside the promise chain
                let html5QrCode = null; 
                
                // Creates a new scanner instance
                html5QrCode = new Html5Qrcode(qrCodeRegionId);
                
                // Configuration for the scanner
                const config = { 
                    fps: 10, 
                    qrbox: { width: 250, height: 250 } 
                };

                // The callback function when a QR code is successfully read
                const onScan = (decodedText, decodedResult) => {
                    // Stop scanning immediately after a successful read
                    if (html5QrCode) {
                        html5QrCode.stop().then(() => {
                            console.log("QR Code scanned successfully:", decodedText);
                            onScanSuccess(decodedText); 
                        }).catch(err => {
                            console.error("Error stopping the scanner after scan:", err);
                        });
                    }
                };

                // Request camera permission and start scanning
                html5QrCode.start(
                    { facingMode: "environment" }, 
                    config, 
                    onScan, 
                    (errorMessage) => { 
                        // console.warn(`QR Code scanning error: ${errorMessage}`); 
                    }
                ).catch(err => {
                    console.error("Error starting camera:", err);
                });

                // Cleanup function: This runs when the component is unmounted (e.g., switching to Public Status)
                return () => {
                    // CRITICAL FIX: The library recommends trying to stop it if the instance exists, 
                    // and its state is usually inferred by the existence of the instance itself.
                    if (html5QrCode && html5QrCode.isScanning) { 
                        // Note: If isScanning is a property (not a function), this works. If it's a function, 
                        // the previous attempt would have failed. We rely on the instance existence check here.
                        html5QrCode.stop().catch(err => {
                            console.error("Error stopping scanner on unmount:", err);
                        });
                    }
                };
            }, []); // Empty dependency array ensures this runs once

            // The component only needs a single div element to host the camera feed
            return (
                <div className="p-4 bg-gray-100 rounded-lg">
                    <h4 className="text-lg font-bold text-gray-800 mb-2">Scan QR Code</h4>
                    <div id={qrCodeRegionId} className="w-full h-64 border-2 border-dashed border-gray-300 rounded-lg overflow-hidden">
                        {/* Camera view will render here */}
                    </div>
                    <p className="text-sm text-gray-500 mt-2 text-center">
                        Point the camera at the Key or Borrower ID QR code.
                    </p>
                </div>
            );
        };

        // Function I-2: KeyCreator (Handles Admin form for adding new keys)

        const KeyCreator = () => {
            const [newKeyId, setNewKeyId] = useState('');
            const [newKeyName, setNewKeyName] = useState('');
            const [newKeyLocation, setNewKeyLocation] = useState('');
            const [isCreating, setIsCreating] = useState(false);

            const handleCreate = async (e) => {
                e.preventDefault();
                if (!newKeyId || !newKeyName || !newKeyLocation) {
                    alert("All fields are required to create a new key.");
                    return;
                }

                setIsCreating(true);
                try {
                    // Ensure admin is signed in before write (safety check)
                    await signInAdmin(); 
                    
                    // Write the new key data using the helper function
                    await writeNewKey(
                        newKeyId.toUpperCase().replace(/\s/g, '_'), // Standardize the ID format
                        newKeyName, 
                        newKeyLocation
                    );

                    alert(`New Key '${newKeyName}' created successfully!`);
                    
                    // Clear the form
                    setNewKeyId('');
                    setNewKeyName('');
                    setNewKeyLocation('');

                } catch (error) {
                    console.error("Key creation failed:", error);
                    alert('Key Creation Failed: ' + error.message);
                } finally {
                    setIsCreating(false);
                }
            };

            return (
                <div className="p-5 bg-teal-100 rounded-xl border-4 border-teal-500 shadow-lg space-y-4">
                    <h4 className="text-2xl font-extrabold text-teal-800 border-b pb-2">Add New Key to System</h4>
                    <form onSubmit={handleCreate} className="space-y-4">
                        <input
                            type="text"
                            value={newKeyId}
                            onChange={(e) => setNewKeyId(e.target.value)}
                            placeholder="Enter Unique Key ID (e.g., LAB_3_KEY)"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg text-md focus:ring-teal-500 focus:border-teal-500"
                            required
                        />
                        <input
                            type="text"
                            value={newKeyName}
                            onChange={(e) => setNewKeyName(e.target.value)}
                            placeholder="Key Name (e.g., Classroom 302 Key)"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg text-md focus:ring-teal-500 focus:border-teal-500"
                            required
                        />
                        <input
                            type="text"
                            value={newKeyLocation}
                            onChange={(e) => setNewKeyLocation(e.target.value)}
                            placeholder="Location (e.g., CCS Building)"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg text-md focus:ring-teal-500 focus:border-teal-500"
                            required
                        />
                        <button
                            type="submit"
                            className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold text-lg hover:bg-blue-700 transition shadow-md"
                            disabled={isCreating}
                        >
                            {isCreating ? 'Creating...' : 'Add Key'}
                        </button>
                    </form>
                </div>
            );
        };

        // Function I-3: TransactionHistory (Reads and displays the transaction log)

        const TransactionHistory = () => {
            const [logs, setLogs] = useState([]);
            const [loadingLogs, setLoadingLogs] = useState(true);

            useEffect(() => {
                const logsRef = database.ref('Logs');
                
                // Order logs by the timestamp and limit to the last 20 entries
                // 'child_added' is efficient for building an ordered list
                logsRef.limitToLast(20).on('value', (snapshot) => {
                    const logsArray = [];
                    snapshot.forEach(childSnapshot => {
                        // Push the log data along with its Firebase unique ID
                        logsArray.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });

                    // Reverse the array so the newest log is at the top
                    setLogs(logsArray.reverse());
                    setLoadingLogs(false);
                });

                // Cleanup listener
                return () => logsRef.off();
            }, []);

            if (loadingLogs) {
                return <p className="text-center text-gray-500">Loading Transaction History...</p>;
            }

            if (logs.length === 0) {
                return <p className="text-center text-gray-500">No transactions recorded yet.</p>;
            }

            return (
                <div className="p-5 bg-white shadow-2xl rounded-2xl space-y-4">
                    <h3 className="text-2xl font-bold text-teal-800 border-b pb-2">Recent Transaction Log (Last 20)</h3>
                    
                    <div className="space-y-3 max-h-96 overflow-y-auto">
                        {logs.map((log) => (
                            <div key={log.id} className={`p-3 rounded-lg border-l-4 ${log.action === 'CHECKOUT' ? 'bg-red-50 border-red-500' : 'bg-green-50 border-green-500'}`}>
                                <p className="text-sm font-bold text-gray-800 flex justify-between">
                                    <span>
                                        <span className={`px-2 py-0.5 rounded-full text-xs font-extrabold ${log.action === 'CHECKOUT' ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`}>
                                            {log.action}
                                        </span>
                                        <span className="ml-2 font-extrabold text-teal-800">{log.keyId}</span>
                                    </span>
                                    <span className="text-xs text-gray-500">
                                        {new Date(log.timestamp).toLocaleDateString()} {formatTime(log.timestamp)}
                                    </span>
                                </p>
                                <p className="text-xs mt-1 text-gray-600">
                                    Borrower ID: {log.borrowerId || 'N/A'} 
                                    {log.duration && ` | Duration: ${log.duration} hrs`}
                                </p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Function G-2 : AdminPortal (Updated for Thematic Separation)

        // --- ADMIN PORTAL COMPONENT (Handles Login Gate) ---
        const AdminPortal = ({ keys }) => {
            // State to manage input and authentication status
            const [passcode, setPasscode] = useState('');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isSigningIn, setIsSigningIn] = useState(false);
            const [selectedKeyId, setSelectedKeyId] = useState(Object.keys(keys)[0] || '');

            // Logic to attempt sign-in and password check
            const handleLogin = async (e) => {
                e.preventDefault();
                // Prototype Password Check: Simple security gate
                if (passcode !== 'CCS2025') { 
                    alert('Invalid Passcode. Use CCS2025');
                    return;
                }
                setIsSigningIn(true);
                try {
                    // Signs the user into Firebase anonymously to grant write permission
                    await signInAdmin(); 
                    setIsAuthenticated(true); 
                } catch (error) {
                    alert('Authentication Failed: ' + error.message);
                } finally {
                    setIsSigningIn(false);
                }
            };

            if (!isAuthenticated) {
                // --- LOGIN SCREEN RENDER: Dark Theme for Security Gate ---
                return (
                    // NEW: Darker background for the login box
                    <div className="max-w-xs mx-auto p-6 mt-10 bg-teal-800 shadow-2xl rounded-xl"> 
                        <h2 className="text-xl font-bold text-white mb-4 text-center">Key Keeper Login</h2>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input
                                type="password"
                                value={passcode}
                                onChange={(e) => setPasscode(e.target.value.toUpperCase())}
                                placeholder="Enter Passcode (CCS2025)"
                                // Input colors adjusted for dark background
                                className="w-full p-3 border border-teal-600 rounded-lg focus:ring-blue-500 text-teal-900 placeholder-gray-500"
                                disabled={isSigningIn}
                            />
                            <button
                                type="submit"
                                // Button uses the bright, active TEAL-600 color
                                className="w-full bg-teal-600 text-white p-3 rounded-lg font-semibold hover:bg-teal-700 transition shadow-lg"
                                disabled={isSigningIn}
                            >
                                {isSigningIn ? 'Signing In...' : 'Access Portal'}
                            </button>
                        </form>
                    </div>
                );
            }

            // If authenticated, render the Key Management Panel
            return (
                <div className="space-y-6">

                    {/* NEW: Key Creation Component */}
                    <KeyCreator /> 

                    {/* Checkout/Return Forms */}
                    <KeyManagementPanel keys={keys} selectedKeyId={selectedKeyId} setSelectedKeyId={setSelectedKeyId} />
                    
                    {/* NEW: Transaction History Viewer */}
                    <TransactionHistory />
                    
                </div>
            );
        };



        // Function H: The Main App Component (Updated for Teal/Blue Theme)
        const App = () => {
            const [keys, setKeys] = useState({});
            const [loading, setLoading] = useState(true);
            const [viewMode, setViewMode] = useState('public'); 
            const [currentTime, setCurrentTime] = useState(new Date());

            // Effect for updating the clock every second
            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);

                // Cleanup function to clear the interval when the component unmounts
                return () => clearInterval(timer);
            }, []); // Run once on mount

            useEffect(() => {
                const keysRef = database.ref('Keys'); 
                keysRef.on('value', (snapshot) => {
                    const liveData = snapshot.val() || {};
                    
                    const finalKeys = STATIC_KEY_LIST.map(staticKey => {
                        const liveEntry = liveData[staticKey.id] || {};
                        
                        return {
                            ...staticKey,
                            status: liveEntry.status || 'AVAILABLE',
                            ...liveEntry
                        };
                    });
                
                    const keyMap = finalKeys.reduce((acc, key) => {
                        acc[key.id] = key;
                        return acc;
                    }, {});

                    setKeys(keyMap);
                    setLoading(false);
                });

                return () => keysRef.off();
            }, []);
            
            if (loading) return <div className="text-center p-8 text-lg text-gray-500">Loading Key Status...</div>;


            // 1. Data Processing and Sorting (Must be BEFORE the loading check)
            // This is the line that was likely misplaced or missing.
            const keyArray = Object.values(keys).sort((a, b) => a.name.localeCompare(b.name));

            // 2. Show a loading message while waiting for data
            if (loading) return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-8">
                    <div className="w-12 h-12 border-4 border-teal-500 border-t-transparent border-solid rounded-full animate-spin"></div>
                    <p className="mt-4 text-lg font-semibold text-teal-700">
                        Establishing Realtime Connection...
                    </p>
                    <p className="mt-1 text-sm text-gray-500">
                        Fetching latest key status from the server.
                    </p>
                </div>
            );

            // 3. FINAL RENDER (keyArray is now guaranteed to exist here)
            return (
                    <div className="min-h-screen bg-gray-100 p-2 sm:p-4 font-sans antialiased"> 
                        <div className="max-w-xl lg:max-w-2xl mx-auto space-y-6"> 
                            
                            <header className="py-8 bg-white shadow-lg rounded-b-xl">
                                <h1 className="text-4xl font-extrabold text-teal-800 text-center">
                                    KeyFiRoom - LSPU üîë
                                </h1>
                                <p className="text-center text-md text-gray-500 mt-1">
                                    Check key availability before heading to the office.
                                </p>
                            </header>
                            
                            {/* View Switcher Buttons */}
                            <div className="flex justify-center space-x-2 p-1 bg-white rounded-xl shadow-inner">
                                <button 
                                    onClick={() => setViewMode('public')}
                                    // Public is always Blue
                                    className={`flex-1 p-3 rounded-xl text-sm sm:text-base font-bold transition focus:outline-none ${viewMode === 'public' ? 'bg-blue-700 text-white shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                >
                                    Public Status
                                </button>
                                <button 
                                    onClick={() => setViewMode('admin')}
                                    // Admin is Teal to match the Key Management theme
                                    className={`flex-1 p-3 rounded-xl text-sm sm:text-base font-bold transition focus:outline-none ${viewMode === 'admin' ? 'bg-teal-700 text-white shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                >
                                    Admin Action
                                </button>
                            </div>

                            {viewMode === 'public' && (
                            <div className="space-y-4 pt-2">
                                {/* NEW: Dynamic Clock Display */}
                                <p className="text-sm font-semibold text-gray-700 px-2 text-center">
                                    Current System Time: 
                                    <span className="text-teal-700 ml-2">
                                        {formatTime(currentTime.toISOString())}
                                    </span>
                                </p>
                                {/* End NEW */}
                                <h2 className="text-2xl font-extrabold text-gray-800 px-2">Live Status Feed</h2>
                                
                                {keyArray.map(key => (
                                    <KeyStatusRow key={key.id} keyData={key} />
                                ))}
                            </div>
                        )}
                            
                            {viewMode === 'admin' && (
                                <AdminPortal keys={keys} />
                            )}

                            <footer className="text-center text-xs text-gray-400 pt-8 pb-4">
                                Developed by CCS Students. Data updates instantly.
                            </footer>
                        </div>
                    </div>
                );
        };

        // --- START THE APP ---
        
        // --- 3. THE RENDER CALL WILL BE AT THE VERY BOTTOM (React 18 Update) ---

        // NEW: Uses the modern createRoot API to suppress the React 18 deprecation warning
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
    </script>
</body>
</html>